<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ãƒã‚±ãƒ¢ãƒ³ã—ã‚Šã¨ã‚Š</title>
  <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="ranking.css">
  <script src="common.js" defer></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="ranking.js" defer></script>
  <style>
    body { padding: 15px; }
    h1 { font-size: 1.8rem; margin-bottom: 10px; }
    .game-container { max-width: 400px; width: 100%; }
    .score-area { display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; }
    .score-box { background: #9b8ab8; padding: 8px 16px; border-radius: 6px; text-align: center; }
    .score-box .label { font-size: 0.7rem; color: #e8e0f0; }
    .score-box .value { font-size: 1.2rem; color: white; font-weight: bold; }
    .chain-display { background: #e8e0f0; padding: 12px; border-radius: 8px; margin-bottom: 10px; min-height: 60px; }
    .chain-display .current-char { font-size: 2rem; color: #6b5b7a; font-weight: bold; text-align: center; }
    .chain-display .hint { font-size: 0.85rem; color: #9b8ab8; text-align: center; margin-top: 5px; }
    .history { background: #f5f0fa; border-radius: 8px; padding: 10px; margin-bottom: 10px; max-height: 300px; overflow-y: auto; }
    .history-item { padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; font-size: 0.95rem; display: flex; align-items: center; gap: 12px; }
    .history-item.player { background: #d4f4d4; color: #2d5a2d; }
    .history-item.cpu { background: #d4d4f4; color: #2d2d5a; }
    .history-item .sprite { width: 80px; height: 80px; image-rendering: pixelated; flex-shrink: 0; background: rgba(255,255,255,0.5); border-radius: 8px; }
    .history-item .info { flex: 1; min-width: 0; }
    .history-item .name { font-weight: bold; font-size: 1.1rem; display: block; margin-bottom: 2px; }
    .history-item .region { font-size: 0.75rem; color: #9b8ab8; background: #e8e0f0; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 4px; }
    .history-item .desc { font-size: 0.8rem; color: #666; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .history-item .char { color: #888; font-size: 0.9rem; display: block; margin-top: 4px; }
    .input-area { display: flex; gap: 8px; margin-bottom: 10px; }
    .input-area input { flex: 1; padding: 12px; border: 2px solid #c5b8d8; border-radius: 6px; font-size: 1rem; outline: none; }
    .input-area input:focus { border-color: #7a6b8a; }
    .input-area input:disabled { background: #eee; }
    .message { background: #fff3cd; padding: 10px; border-radius: 6px; margin-bottom: 10px; color: #856404; font-size: 0.9rem; text-align: center; display: none; }
    .message.show { display: block; }
    .message.error { background: #f8d7da; color: #721c24; }
    .message.success { background: #d4edda; color: #155724; }
    .controls { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
    .btn.send { background: #5a9; }
    .btn.send:hover { background: #4a8; }
    .overlay { background: rgba(255,255,255,0.95); }
    .overlay h2 { animation: pop 0.5s ease; }
    @keyframes pop { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }
    .stats { color: #6b5b7a; margin-bottom: 15px; font-size: 0.95rem; }
    .voice-settings { background: #e8e0f0; border-radius: 8px; padding: 12px; margin-top: 10px; }
    .voice-settings summary { cursor: pointer; color: #6b5b7a; font-weight: bold; }
    .voice-settings .content { margin-top: 10px; }
    .voice-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .voice-row label { color: #6b5b7a; font-size: 0.9rem; }
    .voice-toggle { position: relative; width: 50px; height: 26px; }
    .voice-toggle input { opacity: 0; width: 0; height: 0; }
    .voice-toggle .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; border-radius: 26px; transition: 0.3s; }
    .voice-toggle .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
    .voice-toggle input:checked + .slider { background: #9b8ab8; }
    .voice-toggle input:checked + .slider:before { transform: translateX(24px); }
  </style>
</head>
<body>
  <h1>ãƒã‚±ãƒ¢ãƒ³ã—ã‚Šã¨ã‚Š</h1>
  <div class="game-container">
    <div class="score-area">
      <div class="score-box">
        <div class="label">ã¤ã¥ã„ãŸæ•°</div>
        <div class="value" id="chainCount">0</div>
      </div>
      <div class="score-box">
        <div class="label">ãƒ™ã‚¹ãƒˆ</div>
        <div class="value" id="bestCount">0</div>
      </div>
      <button class="btn ranking-btn" id="rankingBtn">ğŸ†</button>
    </div>
    <div class="chain-display">
      <div class="current-char" id="currentChar">å¥½ããªãƒã‚±ãƒ¢ãƒ³ã‹ã‚‰å§‹ã‚ã‚ˆã†ï¼</div>
      <div class="hint" id="hint"></div>
    </div>
    <div class="history" id="history"></div>
    <div class="message" id="message"></div>
    <div class="input-area">
      <input type="text" id="input" placeholder="ãƒã‚±ãƒ¢ãƒ³ã®åå‰ã‚’å…¥åŠ›" autocomplete="off">
      <button class="btn send" id="sendBtn">é€ä¿¡</button>
    </div>
    <div class="controls">
      <button class="btn small" id="hintBtn">ãƒ’ãƒ³ãƒˆ</button>
      <button class="btn small" id="giveupBtn">ã‚®ãƒ–ã‚¢ãƒƒãƒ—</button>
      <button class="btn small" id="restartBtn">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
  </div>
  <details class="how-to-play" style="margin-top: 15px;">
    <summary>ã‚ãã³ã‹ãŸ</summary>
    <div class="content">
      <ul>
        <li>ãƒã‚±ãƒ¢ãƒ³ã®åå‰ã§ã—ã‚Šã¨ã‚Šã‚’ã—ã‚ˆã†ï¼</li>
        <li>å‰ã®ãƒã‚±ãƒ¢ãƒ³ã®<strong>æœ€å¾Œã®æ–‡å­—</strong>ã‹ã‚‰å§‹ã¾ã‚‹åå‰ã‚’ç­”ãˆã¦ã­</li>
        <li>ã€Œ<strong>ãƒ³</strong>ã€ã§çµ‚ã‚ã‚‹ãƒã‚±ãƒ¢ãƒ³ã‚’è¨€ã£ãŸã‚‰è² ã‘ï¼</li>
        <li>åŒã˜ãƒã‚±ãƒ¢ãƒ³ã¯ä½¿ãˆãªã„ã‚ˆ</li>
        <li>ã‚ã‹ã‚‰ãªã‹ã£ãŸã‚‰ã€Œãƒ’ãƒ³ãƒˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­</li>
      </ul>
    </div>
  </details>
  <details class="voice-settings">
    <summary>éŸ³å£°è¨­å®š</summary>
    <div class="content">
      <div class="voice-row">
        <label>é³´ãå£°</label>
        <label class="voice-toggle">
          <input type="checkbox" id="cryEnabled">
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </details>
  <div class="overlay" id="overlay">
    <h2 id="resultTitle">ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</h2>
    <p class="stats" id="resultStats"></p>
    <button class="btn" id="retryBtn">ã‚‚ã†ä¸€åº¦</button>
  </div>

  <script>
    // ãƒã‚±ãƒ¢ãƒ³ãƒªã‚¹ãƒˆï¼ˆJSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
    // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: PokeAPI (https://github.com/PokeAPI/api-data)
    let POKEMON = [];  // [{id, name}, ...]
    let SPRITE_URL = '';  // ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆç”»åƒã®URLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

    // é³´ãå£°è¨­å®š
    const CRY_URL = 'https://raw.githubusercontent.com/PokeAPI/cries/main/cries/pokemon/latest/{id}.ogg';
    let cryEnabled = localStorage.getItem('pokemonCryEnabled') === 'true';
    let cryAudio = null;

    // é³´ãå£°å†ç”Ÿé–¢æ•°
    function playPokemonCry(pokemonId) {
      if (!cryEnabled) return;
      if (cryAudio) {
        cryAudio.pause();
      }
      const url = CRY_URL.replace('{id}', pokemonId);
      cryAudio = new Audio(url);
      cryAudio.volume = 0.5;
      cryAudio.play().catch(() => {}); // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
    }

    // é³´ãå£°è¨­å®šã®åˆæœŸåŒ–
    function initCrySettings() {
      const enabledCheckbox = document.getElementById('cryEnabled');
      enabledCheckbox.checked = cryEnabled;

      enabledCheckbox.addEventListener('change', () => {
        cryEnabled = enabledCheckbox.checked;
        localStorage.setItem('pokemonCryEnabled', cryEnabled);
      });
    }

    // ã²ã‚‰ãŒãªå¤‰æ›ç”¨
    const KATAKANA_TO_HIRAGANA = str => str.replace(/[\u30A1-\u30F6]/g, c => String.fromCharCode(c.charCodeAt(0) - 0x60));
    const HIRAGANA_TO_KATAKANA = str => str.replace(/[\u3041-\u3096]/g, c => String.fromCharCode(c.charCodeAt(0) + 0x60));
    const normalize = str => HIRAGANA_TO_KATAKANA(str.trim().toUpperCase());

    // å°æ–‡å­—ã‚’å¤§æ–‡å­—ã«å¤‰æ›ï¼ˆã‚¡â†’ã‚¢ã€ãƒƒâ†’ãƒ„ãªã©ï¼‰
    const toBigChar = c => {
      const small = 'ã‚¡ã‚£ã‚¥ã‚§ã‚©ãƒ£ãƒ¥ãƒ§ãƒƒ';
      const big = 'ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªãƒ¤ãƒ¦ãƒ¨ãƒ„';
      const idx = small.indexOf(c);
      return idx >= 0 ? big[idx] : c;
    };

    // æœ€å¾Œã®æ–‡å­—ã‚’å–å¾—ï¼ˆãƒ¼ ã¯ç„¡è¦–ï¼‰
    const getLastChar = name => {
      let last = name[name.length - 1];
      if (last === 'ãƒ¼' && name.length > 1) {
        last = name[name.length - 2];
      }
      return toBigChar(last);
    };

    let usedPokemon = new Set();
    let currentChar = '';
    let chainCount = 0;
    let bestCount = parseInt(localStorage.getItem('pokemonShiritoriBest') || '0');
    let gameOver = false;
    let isFirstTurn = true;

    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const historyEl = document.getElementById('history');
    const currentCharEl = document.getElementById('currentChar');
    const hintEl = document.getElementById('hint');
    const messageEl = document.getElementById('message');
    const chainCountEl = document.getElementById('chainCount');
    const bestCountEl = document.getElementById('bestCount');
    const overlay = document.getElementById('overlay');
    const resultTitleEl = document.getElementById('resultTitle');
    const resultStatsEl = document.getElementById('resultStats');

    bestCountEl.textContent = bestCount;

    function showMessage(text, type = '') {
      messageEl.textContent = text;
      messageEl.className = 'message show ' + type;
      setTimeout(() => messageEl.classList.remove('show'), 3000);
    }

    function addHistory(pokemon, isPlayer) {
      const div = document.createElement('div');
      div.className = 'history-item ' + (isPlayer ? 'player' : 'cpu');
      const lastChar = getLastChar(pokemon.name);
      const spriteUrl = SPRITE_URL.replace('{id}', pokemon.id);
      const regionHtml = pokemon.region ? `<span class="region">${pokemon.region}åœ°æ–¹</span>` : '';
      const descHtml = pokemon.description ? `<p class="desc">${pokemon.description}</p>` : '';
      div.innerHTML = `
        <img class="sprite" src="${spriteUrl}" alt="${pokemon.name}" onerror="this.style.display='none'">
        <div class="info">
          <span class="name">${isPlayer ? 'ã‚ãªãŸ' : 'CPU'}: ${pokemon.name}</span>
          ${regionHtml}
          ${descHtml}
          <span class="char">â†’${lastChar}</span>
        </div>`;
      historyEl.appendChild(div);
      historyEl.scrollTop = historyEl.scrollHeight;
    }

    function updateDisplay() {
      chainCountEl.textContent = chainCount;
      if (currentChar) {
        currentCharEl.textContent = `ã€Œ${currentChar}ã€ã‹ã‚‰å§‹ã¾ã‚‹ãƒã‚±ãƒ¢ãƒ³ï¼`;
        // ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º
        const available = getAvailablePokemon(currentChar);
        hintEl.textContent = `æ®‹ã‚Š ${available.length} åŒ¹`;
      }
    }

    function getAvailablePokemon(startChar) {
      return POKEMON.filter(p => p.name[0] === startChar && !usedPokemon.has(p.name));
    }

    function findPokemon(name) {
      const normalized = normalize(name);
      return POKEMON.find(p => p.name === normalized);
    }

    function cpuTurn() {
      const available = getAvailablePokemon(currentChar);
      if (available.length === 0) {
        // CPUãŒç­”ãˆã‚‰ã‚Œãªã„
        endGame(true, 'CPUãŒç­”ãˆã‚‰ã‚Œãªã‹ã£ãŸï¼');
        return;
      }

      // ãƒ³ã§çµ‚ã‚ã‚‰ãªã„ãƒã‚±ãƒ¢ãƒ³ã‚’å„ªå…ˆ
      const safe = available.filter(p => !p.name.endsWith('ãƒ³'));
      const choice = safe.length > 0 ? safe[Math.floor(Math.random() * safe.length)] : available[Math.floor(Math.random() * available.length)];

      setTimeout(() => {
        usedPokemon.add(choice.name);
        addHistory(choice, false);
        playPokemonCry(choice.id);  // é³´ãå£°å†ç”Ÿ
        chainCount++;

        if (choice.name.endsWith('ãƒ³')) {
          endGame(true, 'CPUãŒã€Œãƒ³ã€ã§çµ‚ã‚ã‚‹ãƒã‚±ãƒ¢ãƒ³ã‚’è¨€ã£ãŸï¼');
          return;
        }

        currentChar = getLastChar(choice.name);
        updateDisplay();
        inputEl.disabled = false;
        inputEl.focus();
      }, 800);
    }

    function playerTurn(name) {
      const pokemon = findPokemon(name);

      if (!pokemon) {
        showMessage('ãã®ãƒã‚±ãƒ¢ãƒ³ã¯è¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆ', 'error');
        return false;
      }

      if (usedPokemon.has(pokemon.name)) {
        showMessage('ãã®ãƒã‚±ãƒ¢ãƒ³ã¯ã‚‚ã†ä½¿ã£ãŸã‚ˆ', 'error');
        return false;
      }

      if (!isFirstTurn && pokemon.name[0] !== currentChar) {
        showMessage(`ã€Œ${currentChar}ã€ã‹ã‚‰å§‹ã¾ã‚‹ãƒã‚±ãƒ¢ãƒ³ã‚’è¨€ã£ã¦ã­`, 'error');
        return false;
      }

      usedPokemon.add(pokemon.name);
      addHistory(pokemon, true);
      playPokemonCry(pokemon.id);  // é³´ãå£°å†ç”Ÿ
      chainCount++;
      isFirstTurn = false;

      if (pokemon.name.endsWith('ãƒ³')) {
        endGame(false, 'ã€Œãƒ³ã€ã§çµ‚ã‚ã£ã¡ã‚ƒã£ãŸ...');
        return true;
      }

      currentChar = getLastChar(pokemon.name);
      updateDisplay();
      inputEl.value = '';
      inputEl.disabled = true;

      // CPUã®ã‚¿ãƒ¼ãƒ³
      cpuTurn();
      return true;
    }

    function endGame(playerWin, reason) {
      gameOver = true;
      inputEl.disabled = true;

      if (chainCount > bestCount) {
        bestCount = chainCount;
        localStorage.setItem('pokemonShiritoriBest', bestCount);
        bestCountEl.textContent = bestCount;
      }

      resultTitleEl.textContent = playerWin ? 'ã‚„ã£ãŸã­ï¼' : 'ã–ã‚“ã­ã‚“...';
      resultStatsEl.textContent = `${reason}\nã¤ã¥ã„ãŸæ•°: ${chainCount}`;

      // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã‚’è¡¨ç¤º
      overlay.classList.add('show');

      // ã‚¹ã‚³ã‚¢ãŒ1ä»¥ä¸Šãªã‚‰ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚è¡¨ç¤º
      if (chainCount > 0) {
        setTimeout(() => {
          Ranking.showSubmitModal('pokemon-shiritori', chainCount, () => {});
        }, 300);
      }
    }

    function showHint() {
      if (gameOver || isFirstTurn) {
        showMessage('å¥½ããªãƒã‚±ãƒ¢ãƒ³ã‹ã‚‰å§‹ã‚ã¦ã­ï¼', 'success');
        return;
      }

      const available = getAvailablePokemon(currentChar);
      if (available.length > 0) {
        const hint = available[Math.floor(Math.random() * available.length)];
        showMessage(`ãƒ’ãƒ³ãƒˆ: ${hint.name.substring(0, 2)}...`, 'success');
      } else {
        showMessage('ç­”ãˆã‚‰ã‚Œã‚‹ãƒã‚±ãƒ¢ãƒ³ãŒã„ãªã„ï¼ã‚®ãƒ–ã‚¢ãƒƒãƒ—ã—ã‚ˆã†', 'error');
      }
    }

    function restart() {
      usedPokemon.clear();
      currentChar = '';
      chainCount = 0;
      gameOver = false;
      isFirstTurn = true;
      historyEl.innerHTML = '';
      inputEl.value = '';
      inputEl.disabled = false;
      currentCharEl.textContent = 'å¥½ããªãƒã‚±ãƒ¢ãƒ³ã‹ã‚‰å§‹ã‚ã‚ˆã†ï¼';
      hintEl.textContent = '';
      overlay.classList.remove('show');
      updateDisplay();
      inputEl.focus();
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆ
    sendBtn.addEventListener('click', () => {
      if (!gameOver && inputEl.value.trim()) {
        playerTurn(inputEl.value);
      }
    });

    inputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !gameOver && inputEl.value.trim()) {
        playerTurn(inputEl.value);
      }
    });

    document.getElementById('hintBtn').addEventListener('click', showHint);
    document.getElementById('giveupBtn').addEventListener('click', () => {
      if (!gameOver) {
        endGame(false, 'ã‚®ãƒ–ã‚¢ãƒƒãƒ—');
      }
    });
    document.getElementById('restartBtn').addEventListener('click', restart);
    document.getElementById('retryBtn').addEventListener('click', restart);

    // ãƒã‚±ãƒ¢ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
    async function initGame() {
      try {
        currentCharEl.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
        inputEl.disabled = true;

        const response = await fetch('pokemon-data.json');
        const data = await response.json();
        POKEMON = data.pokemon;
        SPRITE_URL = data.spriteUrl;

        currentCharEl.textContent = 'å¥½ããªãƒã‚±ãƒ¢ãƒ³ã‹ã‚‰å§‹ã‚ã‚ˆã†ï¼';
        hintEl.textContent = `å…¨${POKEMON.length}åŒ¹ã®ãƒã‚±ãƒ¢ãƒ³ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™`;
        inputEl.disabled = false;
        inputEl.focus();
      } catch (error) {
        currentCharEl.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
        console.error('ãƒã‚±ãƒ¢ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒœã‚¿ãƒ³
    document.getElementById('rankingBtn').addEventListener('click', () => {
      Ranking.showRankingModal('pokemon-shiritori');
    });

    // åˆæœŸåŒ–
    initGame();
    initCrySettings();
  </script>
</body>
</html>
