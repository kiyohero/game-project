<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>å°†æ£‹</title>
  <link rel="stylesheet" href="common.css">
  <script src="common.js" defer></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ -->
  <link rel="stylesheet" href="ranking.css">
  <script src="firebase-config.js"></script>
  <script src="ranking.js" defer></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f0fa; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 15px; user-select: none; -webkit-user-select: none; }
    h1 { font-size: 2rem; color: #6b5b7a; margin-bottom: 10px; }
    .how-to-play { background: #e8e0f0; border-radius: 8px; margin-bottom: 15px; max-width: 360px; width: 100%; }
    .how-to-play summary { color: #6b5b7a; font-size: 1.1rem; font-weight: bold; padding: 12px 15px; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; }
    .how-to-play summary::-webkit-details-marker { display: none; }
    .how-to-play summary::after { content: '+'; font-size: 1.3rem; }
    .how-to-play[open] summary::after { content: '-'; }
    .how-to-play .content { color: #6b5b7a; font-size: 0.9rem; line-height: 1.8; padding: 0 15px 15px 15px; }
    .how-to-play ul { padding-left: 20px; }
    .how-to-play li { margin-bottom: 5px; }
    .controls { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; justify-content: center; }
    .btn { background: #7a6b8a; color: white; border: none; padding: 10px 16px; border-radius: 6px; font-size: 0.9rem; font-weight: bold; cursor: pointer; }
    .btn:active { transform: scale(0.95); }
    .btn.small { padding: 6px 12px; font-size: 0.8rem; }
    .mode-btn { background: #c5b8d8; color: #6b5b7a; }
    .mode-btn.active { background: #7a6b8a; color: white; }
    .turn-indicator { background: #e8e0f0; padding: 8px 16px; border-radius: 6px; margin-bottom: 10px; color: #6b5b7a; font-weight: bold; font-size: 1.1rem; }
    .game-area { display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .hand { display: flex; flex-wrap: wrap; gap: 4px; padding: 8px; background: #d4c8e0; border-radius: 6px; min-height: 50px; min-width: 200px; justify-content: center; align-items: center; }
    .hand-label { font-size: 0.8rem; color: #6b5b7a; margin-bottom: 4px; text-align: center; }
    .hand-piece { width: 36px; height: 40px; background: #f5e6c8; border: 1px solid #c9a96e; border-radius: 4px 4px 8px 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; color: #333; cursor: pointer; position: relative; clip-path: polygon(10% 0%, 90% 0%, 100% 15%, 100% 100%, 0% 100%, 0% 15%); }
    .hand-piece:hover { background: #ffe9a8; }
    .hand-piece.selected { background: #90EE90; }
    .hand-piece .count { position: absolute; bottom: 2px; right: 2px; font-size: 0.6rem; background: #7a6b8a; color: white; border-radius: 50%; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; }
    .board { background: #d4a855; padding: 2px; border-radius: 4px; display: grid; grid-template-columns: repeat(9, 1fr); gap: 1px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .cell { width: 38px; height: 42px; background: #e8c97a; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; border: 1px solid #c9a96e; }
    .cell:hover { background: #f0d88a; }
    .cell.can-move { background: #90EE90; }
    .cell.can-move:hover { background: #7ddc7d; }
    .cell.last-move { background: #b8d4a8; }
    .cell.selected { background: #FFD700; }
    .piece { width: 34px; height: 38px; background: #f5e6c8; border: 1px solid #c9a96e; border-radius: 4px 4px 8px 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; font-weight: bold; color: #333; position: relative; clip-path: polygon(10% 0%, 90% 0%, 100% 15%, 100% 100%, 0% 100%, 0% 15%); transition: transform 0.1s; }
    .piece.enemy { transform: rotate(180deg); }
    .piece.promoted { color: #c41e3a; }
    .piece.movable { box-shadow: 0 0 8px 3px rgba(100, 200, 100, 0.8); }
    .piece:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .piece.movable:hover { box-shadow: 0 0 12px 5px rgba(100, 200, 100, 0.9); }
    .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .overlay.show { opacity: 1; pointer-events: auto; }
    .overlay h2 { font-size: 2rem; color: #6b5b7a; margin-bottom: 15px; }
    .overlay p { color: #6b5b7a; margin-bottom: 20px; }
    .promote-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 200; display: none; flex-direction: column; align-items: center; gap: 15px; }
    .promote-dialog.show { display: flex; }
    .promote-dialog h3 { color: #6b5b7a; }
    .promote-dialog .buttons { display: flex; gap: 10px; }
    .help-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 300; padding: 20px; }
    .help-modal.show { display: flex; }
    .help-content { background: white; border-radius: 10px; padding: 20px; max-width: 360px; max-height: 80vh; overflow-y: auto; }
    .help-content h3 { color: #6b5b7a; margin-bottom: 15px; text-align: center; }
    .piece-help { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
    .piece-info { background: #f5f0fa; padding: 10px; border-radius: 6px; text-align: center; }
    .piece-info .name { font-weight: bold; color: #6b5b7a; margin-bottom: 5px; }
    .piece-info .moves { font-size: 0.75rem; color: #888; }
    .move-grid { display: grid; grid-template-columns: repeat(3, 16px); gap: 2px; margin: 5px auto; width: fit-content; }
    .move-grid.wide { grid-template-columns: repeat(5, 14px); }
    .move-cell { width: 16px; height: 16px; background: #ddd; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; }
    .move-grid.wide .move-cell { width: 14px; height: 14px; }
    .move-cell.center { background: #7a6b8a; color: white; }
    .move-cell.can { background: #90EE90; }
    .move-cell.far { background: #66cc66; font-size: 0.5rem; }
    .tips-content { background: white; border-radius: 10px; padding: 20px; max-width: 360px; max-height: 80vh; overflow-y: auto; }
    .tips-content h3 { color: #6b5b7a; margin-bottom: 15px; text-align: center; }
    .tips-content h4 { color: #7a6b8a; margin: 15px 0 8px 0; font-size: 1rem; border-bottom: 2px solid #e8e0f0; padding-bottom: 5px; }
    .tips-content p, .tips-content li { color: #6b5b7a; font-size: 0.85rem; line-height: 1.6; }
    .tips-content ul { padding-left: 20px; margin-bottom: 10px; }
    .tips-content li { margin-bottom: 5px; }
    .tips-content .tip-box { background: #f5f0fa; padding: 10px; border-radius: 6px; margin: 10px 0; }
    .tips-content .tip-box.important { background: #fff3cd; border-left: 4px solid #ffc107; }
    .header-row { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
    .wins-box { background: #9b8ab8; padding: 8px 16px; border-radius: 6px; text-align: center; }
    .wins-box .label { font-size: 0.7rem; color: #e8e0f0; }
    .wins-box .value { font-size: 1.2rem; color: white; font-weight: bold; }
    .hint-bar { background: #fff3cd; padding: 8px 12px; border-radius: 6px; margin-bottom: 10px; color: #856404; font-size: 0.85rem; max-width: 360px; text-align: center; display: none; }
    .hint-bar.show { display: block; }
    @media (max-width: 400px) {
      .cell { width: 34px; height: 38px; }
      .piece { width: 30px; height: 34px; font-size: 0.85rem; }
      .hand-piece { width: 32px; height: 36px; font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <h1>å°†æ£‹</h1>
  <div class="header-row">
    <div class="wins-box">
      <div class="label">å‹åˆ©æ•°</div>
      <div class="value" id="wins">0</div>
    </div>
    <button class="btn ranking-btn" id="rankingBtn">ğŸ†</button>
  </div>
  <div class="turn-indicator" id="turnIndicator">â–² ã‚ãªãŸã®ã°ã‚“</div>
  <div class="game-area">
    <div>
      <div class="hand-label">ç›¸æ‰‹ã®æŒã¡é§’</div>
      <div class="hand" id="enemyHand"></div>
    </div>
    <div class="board" id="board"></div>
    <div>
      <div class="hand-label">ã‚ãªãŸã®æŒã¡é§’</div>
      <div class="hand" id="playerHand"></div>
    </div>
  </div>
  <div class="controls">
    <button class="btn mode-btn active" id="vsPlayer">2äººã§å¯¾æˆ¦</button>
    <button class="btn mode-btn" id="vsCPU">CPUã¨å¯¾æˆ¦</button>
    <button class="btn small" id="helpBtn">é§’ã®å‹•ã</button>
    <button class="btn small" id="tipsBtn">ä¸Šé”ã®ã‚³ãƒ„</button>
    <button class="btn small" id="restart">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  </div>
  <div class="hint-bar" id="hintBar"></div>
  <details class="how-to-play">
    <summary>ã‚ãã³ã‹ãŸ</summary>
    <div class="content">
      <ul>
        <li><strong>å…‰ã£ã¦ã„ã‚‹é§’</strong>ãŒå‹•ã‹ã›ã‚‹ã‚ˆï¼ã‚¿ãƒƒãƒ—ã—ã¦ã¿ã‚ˆã†</li>
        <li>é§’ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€å‹•ã‘ã‚‹å ´æ‰€ãŒ<span style="color: green;">ç·‘è‰²</span>ã«å…‰ã‚‹ã‚ˆï¼</li>
        <li>ç·‘ã®ãƒã‚¹ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ãã“ã«å‹•ã‘ã‚‹ã‚ˆ</li>
        <li>ç›¸æ‰‹ã®é§’ã‚’å–ã£ãŸã‚‰ã€<strong>æŒã¡é§’</strong>ã¨ã—ã¦ä½¿ãˆã‚‹ã‚ˆ</li>
        <li>æ•µã®é™£åœ°ï¼ˆä¸Šã‹ã‚‰3æ®µï¼‰ã«å…¥ã‚‹ã¨<strong>ã€Œæˆã‚‹ã€</strong>ã“ã¨ãŒã§ãã‚‹ã‚ˆ</li>
        <li>ç›¸æ‰‹ã®<strong>ç‹</strong>ã‚’å–ã£ãŸã‚‰å‹ã¡ï¼</li>
      </ul>
      <p style="margin-top: 10px;"><strong>ã€Œé§’ã®å‹•ãã€</strong>ãƒœã‚¿ãƒ³ã§å„é§’ã®å‹•ãã‹ãŸã‚’è¦‹ã¦ã­ï¼</p>
    </div>
  </details>
  <div class="overlay" id="overlay">
    <h2 id="winner">å‹ã¡ï¼</h2>
    <p id="resultMsg"></p>
    <button class="btn" id="retryBtn">ã‚‚ã†ä¸€åº¦</button>
  </div>
  <div class="promote-dialog" id="promoteDialog">
    <h3>æˆã‚Šã¾ã™ã‹ï¼Ÿ</h3>
    <div class="buttons">
      <button class="btn" id="promoteYes">æˆã‚‹</button>
      <button class="btn" id="promoteNo">æˆã‚‰ãªã„</button>
    </div>
  </div>
  <div class="help-modal" id="helpModal">
    <div class="help-content">
      <h3>é§’ã®å‹•ãã‹ãŸ</h3>
      <p style="font-size: 0.8rem; color: #666; text-align: center; margin-bottom: 10px;">ç·‘ã®ãƒã‚¹ã«å‹•ã‘ã‚‹ã‚ˆï¼</p>
      <div class="piece-help" id="pieceHelp"></div>
      <button class="btn" id="closeHelp" style="width: 100%;">ã¨ã˜ã‚‹</button>
    </div>
  </div>

  <div class="help-modal" id="tipsModal">
    <div class="tips-content">
      <h3>ä¸Šé”ã®ã‚³ãƒ„</h3>

      <h4>ã¾ãšã¯ã“ã‚Œã ã‘è¦šãˆã‚ˆã†ï¼</h4>
      <div class="tip-box important">
        <strong>ç‹ã•ã¾ã‚’å®ˆã‚ã†ï¼</strong><br>
        ç‹ã•ã¾ã‚’å–ã‚‰ã‚ŒãŸã‚‰è² ã‘ã ã‚ˆã€‚ã„ã¤ã‚‚ç‹ã•ã¾ã®å®‰å…¨ã‚’è€ƒãˆã‚ˆã†ï¼
      </div>

      <h4>åˆå¿ƒè€…ãƒ¬ãƒ™ãƒ«</h4>
      <ul>
        <li><strong>æ­©ã‚’å‰ã«é€²ã‚ã‚ˆã†</strong> - ã¾ãšã¯æ­©ã‚’å‹•ã‹ã—ã¦é“ã‚’ä½œã‚ã†</li>
        <li><strong>é£›è»Šã¨è§’ã‚’ä½¿ãŠã†</strong> - ãŸãã•ã‚“å‹•ã‘ã‚‹å¼·ã„é§’ã ã‚ˆ</li>
        <li><strong>å–ã£ãŸé§’ã‚’ä½¿ãŠã†</strong> - æŒã¡é§’ã¯å¥½ããªå ´æ‰€ã«ç½®ã‘ã‚‹ã‚ˆ</li>
      </ul>

      <h4>ä¸­ç´šè€…ãƒ¬ãƒ™ãƒ«</h4>
      <ul>
        <li><strong>é§’ã‚’é€£æºã•ã›ã‚ˆã†</strong> - 1ã¤ã®é§’ã ã‘ã˜ã‚ƒãªãã€ä»²é–“ã¨å”åŠ›ï¼</li>
        <li><strong>ç›¸æ‰‹ã®ç‹ã‚’æ”»ã‚ã‚ˆã†</strong> - ç‹ã®å‘¨ã‚Šã«é§’ã‚’é›†ã‚ã‚ˆã†</li>
        <li><strong>æˆã‚Œã‚‹ã¨ãã¯æˆã‚ã†</strong> - æ•µé™£ã«å…¥ã£ãŸã‚‰ã€Œæˆã‚‹ã€ã¨å¼·ããªã‚‹ã‚ˆ</li>
      </ul>

      <h4>ä¸Šç´šè€…ãƒ¬ãƒ™ãƒ«</h4>
      <ul>
        <li><strong>å›²ã„ã‚’ä½œã‚ã†</strong> - ç‹ã•ã¾ã‚’é‡‘éŠ€ã§å›²ã£ã¦å®ˆã‚‹é™£å½¢</li>
        <li><strong>ç›¸æ‰‹ã®é§’ã®åˆ©ãã‚’è¦‹ã‚ˆã†</strong> - å–ã‚‰ã‚Œãªã„å ´æ‰€ã«é§’ã‚’ç½®ã“ã†</li>
        <li><strong>å…ˆã‚’èª­ã‚‚ã†</strong> - ã€Œã“ã†å‹•ã‹ã—ãŸã‚‰ç›¸æ‰‹ã¯ã©ã†ã™ã‚‹ï¼Ÿã€ã‚’è€ƒãˆã‚ˆã†</li>
      </ul>

      <h4>å¼·ã„é§’ã®ä½¿ã„æ–¹</h4>
      <div class="tip-box">
        <strong>é£›è»Šï¼ˆã²ã—ã‚ƒï¼‰</strong>ï¼šç¸¦æ¨ªã«ã©ã“ã¾ã§ã‚‚å‹•ã‘ã‚‹æœ€å¼·ã‚¯ãƒ©ã‚¹ã®é§’ã€‚åºç›¤ã¯å¤§äº‹ã«ä½¿ãŠã†ã€‚
      </div>
      <div class="tip-box">
        <strong>è§’ï¼ˆã‹ãï¼‰</strong>ï¼šæ–œã‚ã«ã©ã“ã¾ã§ã‚‚å‹•ã‘ã‚‹ã€‚é£›è»Šã¨åˆã‚ã›ã¦ä½¿ã†ã¨å¼·åŠ›ï¼
      </div>
      <div class="tip-box">
        <strong>é‡‘ãƒ»éŠ€</strong>ï¼šç‹ã•ã¾ã‚’å®ˆã‚‹å¤§åˆ‡ãªé§’ã€‚ç‹ã®è¿‘ãã«ç½®ã„ã¦ãŠã“ã†ã€‚
      </div>

      <button class="btn" id="closeTips" style="width: 100%; margin-top: 15px;">ã¨ã˜ã‚‹</button>
    </div>
  </div>

  <script>
    // é§’ã®ç¨®é¡
    const PIECES = {
      EMPTY: 0,
      // å…ˆæ‰‹
      OU: 1, HI: 2, KAKU: 3, KIN: 4, GIN: 5, KEI: 6, KYOU: 7, FU: 8,
      // æˆã‚Šé§’
      RYU: 12, UMA: 13, NGIN: 15, NKEI: 16, NKYOU: 17, TO: 18,
      // å¾Œæ‰‹ï¼ˆ+20ï¼‰
      E_OU: 21, E_HI: 22, E_KAKU: 23, E_KIN: 24, E_GIN: 25, E_KEI: 26, E_KYOU: 27, E_FU: 28,
      E_RYU: 32, E_UMA: 33, E_NGIN: 35, E_NKEI: 36, E_NKYOU: 37, E_TO: 38
    };

    // é§’ã®è¡¨ç¤ºå
    const PIECE_NAMES = {
      [PIECES.OU]: 'ç‹', [PIECES.HI]: 'é£›', [PIECES.KAKU]: 'è§’', [PIECES.KIN]: 'é‡‘',
      [PIECES.GIN]: 'éŠ€', [PIECES.KEI]: 'æ¡‚', [PIECES.KYOU]: 'é¦™', [PIECES.FU]: 'æ­©',
      [PIECES.RYU]: 'ç«œ', [PIECES.UMA]: 'é¦¬', [PIECES.NGIN]: 'å…¨', [PIECES.NKEI]: 'åœ­',
      [PIECES.NKYOU]: 'æ', [PIECES.TO]: 'ã¨',
      [PIECES.E_OU]: 'ç‹', [PIECES.E_HI]: 'é£›', [PIECES.E_KAKU]: 'è§’', [PIECES.E_KIN]: 'é‡‘',
      [PIECES.E_GIN]: 'éŠ€', [PIECES.E_KEI]: 'æ¡‚', [PIECES.E_KYOU]: 'é¦™', [PIECES.E_FU]: 'æ­©',
      [PIECES.E_RYU]: 'ç«œ', [PIECES.E_UMA]: 'é¦¬', [PIECES.E_NGIN]: 'å…¨', [PIECES.E_NKEI]: 'åœ­',
      [PIECES.E_NKYOU]: 'æ', [PIECES.E_TO]: 'ã¨'
    };

    // æŒã¡é§’ç”¨ã®åå‰ï¼ˆæˆã‚Šé§’ã¯å…ƒã«æˆ»ã™ï¼‰
    const HAND_NAMES = { 'HI': 'é£›', 'KAKU': 'è§’', 'KIN': 'é‡‘', 'GIN': 'éŠ€', 'KEI': 'æ¡‚', 'KYOU': 'é¦™', 'FU': 'æ­©' };

    // æˆã‚Šé§’ã‹ã©ã†ã‹
    const isPromoted = (p) => [12,13,15,16,17,18,32,33,35,36,37,38].includes(p);

    // æ•µã®é§’ã‹ã©ã†ã‹
    const isEnemy = (p) => p >= 21;

    // é§’ã‚’æŒã¡é§’ã«å¤‰æ›
    const toHandPiece = (p) => {
      const base = p >= 21 ? p - 20 : p;
      if (base === 12) return 'HI';
      if (base === 13) return 'KAKU';
      if (base >= 15 && base <= 17) return ['GIN', 'KEI', 'KYOU'][base - 15];
      if (base === 18) return 'FU';
      if (base === 1) return null; // ç‹ã¯å–ã‚Œãªã„ï¼ˆã‚²ãƒ¼ãƒ çµ‚äº†ï¼‰
      return ['', 'OU', 'HI', 'KAKU', 'KIN', 'GIN', 'KEI', 'KYOU', 'FU'][base];
    };

    // æŒã¡é§’ã‚’ç›¤ä¸Šã®é§’ã«å¤‰æ›
    const handToPiece = (name, isEnemySide) => {
      const map = { 'HI': 2, 'KAKU': 3, 'KIN': 4, 'GIN': 5, 'KEI': 6, 'KYOU': 7, 'FU': 8 };
      return map[name] + (isEnemySide ? 20 : 0);
    };

    let board = [];
    let currentPlayer = 0; // 0: å…ˆæ‰‹ï¼ˆä¸‹ï¼‰, 1: å¾Œæ‰‹ï¼ˆä¸Šï¼‰
    let selectedCell = null;
    let selectedHandPiece = null;
    let validMoves = [];
    let lastMove = null;
    let isCPUMode = false;
    let gameOver = false;
    let playerHand = { HI: 0, KAKU: 0, KIN: 0, GIN: 0, KEI: 0, KYOU: 0, FU: 0 };
    let enemyHand = { HI: 0, KAKU: 0, KIN: 0, GIN: 0, KEI: 0, KYOU: 0, FU: 0 };
    let pendingPromotion = null;
    let wins = parseInt(localStorage.getItem('shogi-wins') || '0');
    const winsEl = document.getElementById('wins');
    winsEl.textContent = wins;

    const boardEl = document.getElementById('board');
    const playerHandEl = document.getElementById('playerHand');
    const enemyHandEl = document.getElementById('enemyHand');
    const turnIndicatorEl = document.getElementById('turnIndicator');
    const overlay = document.getElementById('overlay');
    const winnerEl = document.getElementById('winner');
    const promoteDialog = document.getElementById('promoteDialog');
    const helpModal = document.getElementById('helpModal');

    // åˆæœŸé…ç½®
    function initBoard() {
      board = [];
      for (let r = 0; r < 9; r++) {
        board[r] = [];
        for (let c = 0; c < 9; c++) {
          board[r][c] = PIECES.EMPTY;
        }
      }
      // å¾Œæ‰‹ï¼ˆä¸Šå´ï¼‰
      board[0][0] = PIECES.E_KYOU; board[0][1] = PIECES.E_KEI; board[0][2] = PIECES.E_GIN;
      board[0][3] = PIECES.E_KIN; board[0][4] = PIECES.E_OU; board[0][5] = PIECES.E_KIN;
      board[0][6] = PIECES.E_GIN; board[0][7] = PIECES.E_KEI; board[0][8] = PIECES.E_KYOU;
      board[1][1] = PIECES.E_HI; board[1][7] = PIECES.E_KAKU;
      for (let c = 0; c < 9; c++) board[2][c] = PIECES.E_FU;

      // å…ˆæ‰‹ï¼ˆä¸‹å´ï¼‰
      board[8][0] = PIECES.KYOU; board[8][1] = PIECES.KEI; board[8][2] = PIECES.GIN;
      board[8][3] = PIECES.KIN; board[8][4] = PIECES.OU; board[8][5] = PIECES.KIN;
      board[8][6] = PIECES.GIN; board[8][7] = PIECES.KEI; board[8][8] = PIECES.KYOU;
      board[7][7] = PIECES.HI; board[7][1] = PIECES.KAKU;
      for (let c = 0; c < 9; c++) board[6][c] = PIECES.FU;

      currentPlayer = 0;
      selectedCell = null;
      selectedHandPiece = null;
      validMoves = [];
      lastMove = null;
      gameOver = false;
      playerHand = { HI: 0, KAKU: 0, KIN: 0, GIN: 0, KEI: 0, KYOU: 0, FU: 0 };
      enemyHand = { HI: 0, KAKU: 0, KIN: 0, GIN: 0, KEI: 0, KYOU: 0, FU: 0 };
      overlay.classList.remove('show');
      render();
    }

    // é§’ã®å‹•ãã‚’å–å¾—
    function getMoves(piece, row, col, checkKing = true) {
      const moves = [];
      const isE = isEnemy(piece);
      const dir = isE ? 1 : -1; // æ•µã¯ä¸‹å‘ãã€å‘³æ–¹ã¯ä¸Šå‘ã
      const base = isE ? piece - 20 : piece;

      const addMove = (r, c) => {
        if (r < 0 || r > 8 || c < 0 || c > 8) return false;
        const target = board[r][c];
        if (target === PIECES.EMPTY) {
          moves.push([r, c]);
          return true;
        } else if (isEnemy(target) !== isE) {
          moves.push([r, c]);
          return false;
        }
        return false;
      };

      const addLine = (dr, dc) => {
        for (let i = 1; i <= 8; i++) {
          if (!addMove(row + dr * i, col + dc * i)) break;
          if (board[row + dr * i] && board[row + dr * i][col + dc * i] !== PIECES.EMPTY) break;
        }
      };

      // é‡‘ã®å‹•ã
      const kinMoves = () => {
        addMove(row + dir, col);
        addMove(row + dir, col - 1);
        addMove(row + dir, col + 1);
        addMove(row, col - 1);
        addMove(row, col + 1);
        addMove(row - dir, col);
      };

      switch (base) {
        case 1: // ç‹
          for (let dr = -1; dr <= 1; dr++) {
            for (let dc = -1; dc <= 1; dc++) {
              if (dr === 0 && dc === 0) continue;
              addMove(row + dr, col + dc);
            }
          }
          break;
        case 2: // é£›è»Š
          addLine(-1, 0); addLine(1, 0); addLine(0, -1); addLine(0, 1);
          break;
        case 3: // è§’
          addLine(-1, -1); addLine(-1, 1); addLine(1, -1); addLine(1, 1);
          break;
        case 4: // é‡‘
          kinMoves();
          break;
        case 5: // éŠ€
          addMove(row + dir, col);
          addMove(row + dir, col - 1);
          addMove(row + dir, col + 1);
          addMove(row - dir, col - 1);
          addMove(row - dir, col + 1);
          break;
        case 6: // æ¡‚é¦¬
          addMove(row + dir * 2, col - 1);
          addMove(row + dir * 2, col + 1);
          break;
        case 7: // é¦™è»Š
          addLine(dir, 0);
          break;
        case 8: // æ­©
          addMove(row + dir, col);
          break;
        case 12: // ç«œï¼ˆæˆã‚Šé£›è»Šï¼‰
          addLine(-1, 0); addLine(1, 0); addLine(0, -1); addLine(0, 1);
          addMove(row - 1, col - 1); addMove(row - 1, col + 1);
          addMove(row + 1, col - 1); addMove(row + 1, col + 1);
          break;
        case 13: // é¦¬ï¼ˆæˆã‚Šè§’ï¼‰
          addLine(-1, -1); addLine(-1, 1); addLine(1, -1); addLine(1, 1);
          addMove(row - 1, col); addMove(row + 1, col);
          addMove(row, col - 1); addMove(row, col + 1);
          break;
        case 15: case 16: case 17: case 18: // æˆéŠ€ã€æˆæ¡‚ã€æˆé¦™ã€ã¨é‡‘
          kinMoves();
          break;
      }

      return moves;
    }

    // å‹•ã‹ã›ã‚‹é§’ã®ä½ç½®ã‚’å–å¾—
    function getMovablePieces() {
      const movable = [];
      for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
          const piece = board[r][c];
          if (piece === PIECES.EMPTY) continue;
          const isMyPiece = (currentPlayer === 0 && !isEnemy(piece)) || (currentPlayer === 1 && isEnemy(piece));
          if (isMyPiece) {
            const moves = getMoves(piece, r, c);
            if (moves.length > 0) {
              movable.push([r, c]);
            }
          }
        }
      }
      return movable;
    }

    // æŒã¡é§’ã‚’ç½®ã‘ã‚‹å ´æ‰€ã‚’å–å¾—
    function getDropMoves(pieceName, isEnemySide) {
      const moves = [];
      const dir = isEnemySide ? 1 : -1;

      for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
          if (board[r][c] !== PIECES.EMPTY) continue;

          // æ­©ãƒ»é¦™ãƒ»æ¡‚ã®åˆ¶é™
          if (pieceName === 'FU' || pieceName === 'KYOU') {
            if ((isEnemySide && r === 8) || (!isEnemySide && r === 0)) continue;
          }
          if (pieceName === 'KEI') {
            if ((isEnemySide && r >= 7) || (!isEnemySide && r <= 1)) continue;
          }

          // äºŒæ­©ã®ç¦æ­¢
          if (pieceName === 'FU') {
            let hasFu = false;
            for (let row = 0; row < 9; row++) {
              const p = board[row][c];
              if ((isEnemySide && p === PIECES.E_FU) || (!isEnemySide && p === PIECES.FU)) {
                hasFu = true;
                break;
              }
            }
            if (hasFu) continue;
          }

          moves.push([r, c]);
        }
      }
      return moves;
    }

    // æˆã‚Œã‚‹ã‹ã©ã†ã‹
    function canPromote(piece, fromRow, toRow) {
      const base = isEnemy(piece) ? piece - 20 : piece;
      if ([1, 4, 12, 13, 15, 16, 17, 18].includes(base)) return false; // ç‹ã€é‡‘ã€æˆã‚Šé§’ã¯æˆã‚Œãªã„

      const isE = isEnemy(piece);
      if (isE) {
        return fromRow >= 6 || toRow >= 6;
      } else {
        return fromRow <= 2 || toRow <= 2;
      }
    }

    // å¿…ãšæˆã‚‰ãªã‘ã‚Œã°ãªã‚‰ãªã„ã‹
    function mustPromote(piece, toRow) {
      const base = isEnemy(piece) ? piece - 20 : piece;
      const isE = isEnemy(piece);

      if (base === 8 || base === 7) { // æ­©ã€é¦™
        return isE ? toRow === 8 : toRow === 0;
      }
      if (base === 6) { // æ¡‚
        return isE ? toRow >= 7 : toRow <= 1;
      }
      return false;
    }

    // é§’ã‚’æˆã‚‰ã›ã‚‹
    function promotePiece(piece) {
      const isE = isEnemy(piece);
      const base = isE ? piece - 20 : piece;
      let promoted;
      switch (base) {
        case 2: promoted = 12; break; // é£›â†’ç«œ
        case 3: promoted = 13; break; // è§’â†’é¦¬
        case 5: promoted = 15; break; // éŠ€â†’æˆéŠ€
        case 6: promoted = 16; break; // æ¡‚â†’æˆæ¡‚
        case 7: promoted = 17; break; // é¦™â†’æˆé¦™
        case 8: promoted = 18; break; // æ­©â†’ã¨
        default: return piece;
      }
      return isE ? promoted + 20 : promoted;
    }

    // æç”»
    function render() {
      boardEl.innerHTML = '';
      // é§’ãŒé¸æŠã•ã‚Œã¦ã„ãªã„æ™‚ã ã‘ã€å‹•ã‹ã›ã‚‹é§’ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      const movablePieces = (!selectedCell && !selectedHandPiece) ? getMovablePieces() : [];

      for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.row = r;
          cell.dataset.col = c;

          if (lastMove && lastMove[0] === r && lastMove[1] === c) {
            cell.classList.add('last-move');
          }
          if (selectedCell && selectedCell[0] === r && selectedCell[1] === c) {
            cell.classList.add('selected');
          }
          if (validMoves.some(m => m[0] === r && m[1] === c)) {
            cell.classList.add('can-move');
          }

          const piece = board[r][c];
          if (piece !== PIECES.EMPTY) {
            const pieceEl = document.createElement('div');
            pieceEl.className = 'piece';
            if (isEnemy(piece)) pieceEl.classList.add('enemy');
            if (isPromoted(piece)) pieceEl.classList.add('promoted');
            // å‹•ã‹ã›ã‚‹é§’ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            if (movablePieces.some(m => m[0] === r && m[1] === c)) {
              pieceEl.classList.add('movable');
            }
            pieceEl.textContent = PIECE_NAMES[piece];
            cell.appendChild(pieceEl);
          }

          cell.addEventListener('click', () => onCellClick(r, c));
          boardEl.appendChild(cell);
        }
      }

      renderHands();
      updateTurnIndicator();
    }

    function renderHands() {
      playerHandEl.innerHTML = '';
      enemyHandEl.innerHTML = '';

      const renderHand = (hand, el, isEnemySide) => {
        const order = ['HI', 'KAKU', 'KIN', 'GIN', 'KEI', 'KYOU', 'FU'];
        for (const name of order) {
          if (hand[name] > 0) {
            const piece = document.createElement('div');
            piece.className = 'hand-piece';
            if (selectedHandPiece && selectedHandPiece.name === name && selectedHandPiece.isEnemy === isEnemySide) {
              piece.classList.add('selected');
            }
            piece.textContent = HAND_NAMES[name];
            if (hand[name] > 1) {
              const count = document.createElement('span');
              count.className = 'count';
              count.textContent = hand[name];
              piece.appendChild(count);
            }
            piece.addEventListener('click', () => onHandClick(name, isEnemySide));
            el.appendChild(piece);
          }
        }
        if (el.children.length === 0) {
          el.innerHTML = '<span style="color: #999; font-size: 0.8rem;">ãªã—</span>';
        }
      };

      renderHand(playerHand, playerHandEl, false);
      renderHand(enemyHand, enemyHandEl, true);
    }

    function updateTurnIndicator() {
      if (gameOver) {
        turnIndicatorEl.textContent = 'ã‚²ãƒ¼ãƒ çµ‚äº†';
      } else if (currentPlayer === 0) {
        turnIndicatorEl.textContent = 'â–² ã‚ãªãŸã®ã°ã‚“';
      } else {
        turnIndicatorEl.textContent = 'â–³ ç›¸æ‰‹ã®ã°ã‚“';
      }
    }

    function onCellClick(row, col) {
      if (gameOver) return;
      if (isCPUMode && currentPlayer === 1) return;

      const piece = board[row][col];

      // æŒã¡é§’ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
      if (selectedHandPiece) {
        if (validMoves.some(m => m[0] === row && m[1] === col)) {
          // æŒã¡é§’ã‚’ç½®ã
          const newPiece = handToPiece(selectedHandPiece.name, selectedHandPiece.isEnemy);
          board[row][col] = newPiece;

          if (selectedHandPiece.isEnemy) {
            enemyHand[selectedHandPiece.name]--;
          } else {
            playerHand[selectedHandPiece.name]--;
          }

          lastMove = [row, col];
          selectedHandPiece = null;
          validMoves = [];
          nextTurn();
        } else {
          selectedHandPiece = null;
          validMoves = [];
          render();
        }
        return;
      }

      // ç§»å‹•å¯èƒ½ãªãƒã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ
      if (selectedCell && validMoves.some(m => m[0] === row && m[1] === col)) {
        movePiece(selectedCell[0], selectedCell[1], row, col);
        return;
      }

      // è‡ªåˆ†ã®é§’ã‚’é¸æŠ
      const isMyPiece = (currentPlayer === 0 && !isEnemy(piece)) || (currentPlayer === 1 && isEnemy(piece));
      if (piece !== PIECES.EMPTY && isMyPiece) {
        selectedCell = [row, col];
        selectedHandPiece = null;
        validMoves = getMoves(piece, row, col);
        render();
      } else {
        selectedCell = null;
        validMoves = [];
        render();
      }
    }

    function onHandClick(name, isEnemySide) {
      if (gameOver) return;
      if (isCPUMode && currentPlayer === 1) return;

      const isMyHand = (currentPlayer === 0 && !isEnemySide) || (currentPlayer === 1 && isEnemySide);
      if (!isMyHand) return;

      selectedCell = null;
      selectedHandPiece = { name, isEnemy: isEnemySide };
      validMoves = getDropMoves(name, isEnemySide);
      render();
    }

    function movePiece(fromRow, fromCol, toRow, toCol) {
      const piece = board[fromRow][fromCol];
      const captured = board[toRow][toCol];

      // ç‹ã‚’å–ã£ãŸå ´åˆã¯ã‚²ãƒ¼ãƒ çµ‚äº†
      if (captured === PIECES.OU || captured === PIECES.E_OU) {
        board[toRow][toCol] = piece;
        board[fromRow][fromCol] = PIECES.EMPTY;
        lastMove = [toRow, toCol];
        selectedCell = null;
        validMoves = [];
        gameOver = true;
        showGameOver(currentPlayer === 0 ? 'ã‚ãªãŸ' : 'ç›¸æ‰‹');
        render();
        return;
      }

      // é§’ã‚’å–ã£ãŸå ´åˆã€æŒã¡é§’ã«è¿½åŠ 
      if (captured !== PIECES.EMPTY) {
        const handPiece = toHandPiece(captured);
        if (handPiece) {
          if (currentPlayer === 0) {
            playerHand[handPiece]++;
          } else {
            enemyHand[handPiece]++;
          }
        }
      }

      // æˆã‚Šã®åˆ¤å®š
      if (canPromote(piece, fromRow, toRow)) {
        if (mustPromote(piece, toRow)) {
          // å¼·åˆ¶æˆã‚Š
          board[toRow][toCol] = promotePiece(piece);
          board[fromRow][fromCol] = PIECES.EMPTY;
          finishMove(toRow, toCol);
        } else {
          // æˆã‚‹ã‹é¸æŠ
          pendingPromotion = { piece, fromRow, fromCol, toRow, toCol };
          promoteDialog.classList.add('show');
        }
      } else {
        board[toRow][toCol] = piece;
        board[fromRow][fromCol] = PIECES.EMPTY;
        finishMove(toRow, toCol);
      }
    }

    function finishMove(toRow, toCol) {
      lastMove = [toRow, toCol];
      selectedCell = null;
      validMoves = [];
      nextTurn();
    }

    function nextTurn() {
      currentPlayer = 1 - currentPlayer;
      render();

      if (isCPUMode && currentPlayer === 1 && !gameOver) {
        setTimeout(cpuMove, 500);
      }
    }

    // æˆã‚Šã®é¸æŠ
    document.getElementById('promoteYes').addEventListener('click', () => {
      if (!pendingPromotion) return;
      const { piece, fromRow, fromCol, toRow, toCol } = pendingPromotion;
      board[toRow][toCol] = promotePiece(piece);
      board[fromRow][fromCol] = PIECES.EMPTY;
      promoteDialog.classList.remove('show');
      pendingPromotion = null;
      finishMove(toRow, toCol);
    });

    document.getElementById('promoteNo').addEventListener('click', () => {
      if (!pendingPromotion) return;
      const { piece, fromRow, fromCol, toRow, toCol } = pendingPromotion;
      board[toRow][toCol] = piece;
      board[fromRow][fromCol] = PIECES.EMPTY;
      promoteDialog.classList.remove('show');
      pendingPromotion = null;
      finishMove(toRow, toCol);
    });

    // CPU ã®æ‰‹
    function cpuMove() {
      if (gameOver) return;

      const moves = [];

      // ç›¤ä¸Šã®é§’ã®ç§»å‹•
      for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
          const piece = board[r][c];
          if (piece !== PIECES.EMPTY && isEnemy(piece)) {
            const pieceMoves = getMoves(piece, r, c);
            for (const [tr, tc] of pieceMoves) {
              let score = 0;
              const target = board[tr][tc];

              // é§’ã‚’å–ã‚‹æ‰‹ã‚’å„ªå…ˆ
              if (target !== PIECES.EMPTY) {
                const base = target >= 21 ? target - 20 : target;
                score += [0, 1000, 50, 45, 30, 25, 20, 15, 5][base] || 10;
              }

              // æˆã‚Œã‚‹æ‰‹ã‚’å„ªå…ˆ
              if (canPromote(piece, r, tr)) {
                score += 10;
              }

              // å‰é€²ã‚’å°‘ã—å„ªå…ˆ
              score += tr - r;

              moves.push({ type: 'move', from: [r, c], to: [tr, tc], score, piece });
            }
          }
        }
      }

      // æŒã¡é§’ã‚’æ‰“ã¤
      for (const name of Object.keys(enemyHand)) {
        if (enemyHand[name] > 0) {
          const dropMoves = getDropMoves(name, true);
          for (const [tr, tc] of dropMoves) {
            let score = 2;
            // ä¸­å¤®ä»˜è¿‘ã‚’å„ªå…ˆ
            score += 4 - Math.abs(tc - 4);
            moves.push({ type: 'drop', name, to: [tr, tc], score });
          }
        }
      }

      if (moves.length === 0) return;

      // ã‚¹ã‚³ã‚¢ã§ã‚½ãƒ¼ãƒˆã—ã¦ä¸Šä½ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
      moves.sort((a, b) => b.score - a.score);
      const topMoves = moves.filter(m => m.score >= moves[0].score - 5);
      const move = topMoves[Math.floor(Math.random() * topMoves.length)];

      if (move.type === 'move') {
        const [fr, fc] = move.from;
        const [tr, tc] = move.to;
        const piece = board[fr][fc];
        const captured = board[tr][tc];

        // ç‹ã‚’å–ã£ãŸã‚‰å‹ã¡
        if (captured === PIECES.OU) {
          board[tr][tc] = piece;
          board[fr][fc] = PIECES.EMPTY;
          lastMove = [tr, tc];
          gameOver = true;
          showGameOver('ç›¸æ‰‹');
          render();
          return;
        }

        if (captured !== PIECES.EMPTY) {
          const handPiece = toHandPiece(captured);
          if (handPiece) enemyHand[handPiece]++;
        }

        // æˆã‚Œã‚‹ãªã‚‰æˆã‚‹
        if (canPromote(piece, fr, tr)) {
          board[tr][tc] = promotePiece(piece);
        } else {
          board[tr][tc] = piece;
        }
        board[fr][fc] = PIECES.EMPTY;
        lastMove = [tr, tc];
      } else {
        const [tr, tc] = move.to;
        board[tr][tc] = handToPiece(move.name, true);
        enemyHand[move.name]--;
        lastMove = [tr, tc];
      }

      nextTurn();
    }

    function showGameOver(winner) {
      winnerEl.textContent = winner + 'ã®å‹ã¡ï¼';

      // CPUãƒ¢ãƒ¼ãƒ‰ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‹ã£ãŸå ´åˆã€å‹åˆ©æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
      if (isCPUMode && winner === 'ã‚ãªãŸ') {
        wins++;
        localStorage.setItem('shogi-wins', wins);
        winsEl.textContent = wins;
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        setTimeout(() => {
          Ranking.showSubmitModal('shogi', wins, () => {
            overlay.classList.add('show');
          });
        }, 500);
      } else {
        overlay.classList.add('show');
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById('restart').addEventListener('click', initBoard);
    document.getElementById('retryBtn').addEventListener('click', initBoard);

    document.getElementById('vsPlayer').addEventListener('click', () => {
      isCPUMode = false;
      document.getElementById('vsPlayer').classList.add('active');
      document.getElementById('vsCPU').classList.remove('active');
      initBoard();
    });

    document.getElementById('vsCPU').addEventListener('click', () => {
      isCPUMode = true;
      document.getElementById('vsCPU').classList.add('active');
      document.getElementById('vsPlayer').classList.remove('active');
      initBoard();
    });

    // ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«
    document.getElementById('helpBtn').addEventListener('click', () => {
      renderHelp();
      helpModal.classList.add('show');
    });

    document.getElementById('closeHelp').addEventListener('click', () => {
      helpModal.classList.remove('show');
    });

    helpModal.addEventListener('click', (e) => {
      if (e.target === helpModal) helpModal.classList.remove('show');
    });

    // ä¸Šé”ã®ã‚³ãƒ„ãƒ¢ãƒ¼ãƒ€ãƒ«
    const tipsModal = document.getElementById('tipsModal');
    document.getElementById('tipsBtn').addEventListener('click', () => {
      tipsModal.classList.add('show');
    });

    document.getElementById('closeTips').addEventListener('click', () => {
      tipsModal.classList.remove('show');
    });

    tipsModal.addEventListener('click', (e) => {
      if (e.target === tipsModal) tipsModal.classList.remove('show');
    });

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒœã‚¿ãƒ³
    document.getElementById('rankingBtn').addEventListener('click', () => {
      Ranking.showRankingModal('shogi');
    });

    // ãƒ’ãƒ³ãƒˆè¡¨ç¤ºæ©Ÿèƒ½
    const hintBar = document.getElementById('hintBar');
    const hints = [
      'å…‰ã£ã¦ã„ã‚‹é§’ãŒå‹•ã‹ã›ã‚‹ã‚ˆï¼ã‚¿ãƒƒãƒ—ã—ã¦ã¿ã‚ˆã†',
      'é£›è»Šã¨è§’ã¯é ãã¾ã§å‹•ã‘ã‚‹ã‚ˆã€‚å¤§åˆ‡ã«ä½¿ãŠã†ï¼',
      'æŒã¡é§’ã¯å¥½ããªç©ºã„ã¦ã„ã‚‹ãƒã‚¹ã«ç½®ã‘ã‚‹ã‚ˆ',
      'æ•µé™£ï¼ˆä¸Š3æ®µï¼‰ã«å…¥ã£ãŸã‚‰ã€Œæˆã‚‹ã€ã¨å¼·ããªã‚‹ã‚ˆ',
      'ç‹ã•ã¾ã‚’å®ˆã‚ŠãªãŒã‚‰æ”»ã‚ã‚ˆã†',
      'ç›¸æ‰‹ã®é§’ã‚’å–ã‚‹ã¨ã€è‡ªåˆ†ã®æŒã¡é§’ã«ãªã‚‹ã‚ˆ',
      'é‡‘ã¨éŠ€ã§ç‹ã•ã¾ã®å‘¨ã‚Šã‚’å›ºã‚ã‚‹ã¨å®‰å…¨ã ã‚ˆ',
    ];
    let hintIndex = 0;
    let moveCount = 0;

    function showHint(text) {
      hintBar.textContent = text;
      hintBar.classList.add('show');
    }

    function hideHint() {
      hintBar.classList.remove('show');
    }

    function showRandomHint() {
      if (moveCount < 10 && moveCount % 3 === 0) {
        showHint(hints[hintIndex % hints.length]);
        hintIndex++;
      } else if (moveCount >= 10) {
        hideHint();
      }
    }

    // å…ƒã®nextTurné–¢æ•°ã‚’æ‹¡å¼µã—ã¦ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º
    const originalNextTurn = nextTurn;
    nextTurn = function() {
      moveCount++;
      originalNextTurn();
      if (currentPlayer === 0 && !gameOver) {
        showRandomHint();
      }
    };

    // åˆæœŸãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º
    showHint('å…‰ã£ã¦ã„ã‚‹é§’ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å‹•ã‹ã—ã¦ã¿ã‚ˆã†ï¼');

    function renderHelp() {
      const helpEl = document.getElementById('pieceHelp');
      const pieces = [
        { name: 'ç‹', moves: [[1,1,1],[1,0,1],[1,1,1]] },
        { name: 'é£›', moves: [[0,2,0],[2,0,2],[0,2,0]], wide: true, wideData: [[0,0,1,0,0],[0,0,1,0,0],[1,1,0,1,1],[0,0,1,0,0],[0,0,1,0,0]] },
        { name: 'è§’', moves: [[2,0,2],[0,0,0],[2,0,2]], wide: true, wideData: [[1,0,0,0,1],[0,1,0,1,0],[0,0,0,0,0],[0,1,0,1,0],[1,0,0,0,1]] },
        { name: 'é‡‘', moves: [[1,1,1],[1,0,1],[0,1,0]] },
        { name: 'éŠ€', moves: [[1,1,1],[0,0,0],[1,0,1]] },
        { name: 'æ¡‚', moves: [[1,0,1],[0,0,0],[0,0,0],[0,0,0]], special: 'knight' },
        { name: 'é¦™', moves: [[0,2,0],[0,0,0],[0,0,0]], wide: false, tall: true },
        { name: 'æ­©', moves: [[0,1,0],[0,0,0],[0,0,0]] },
        { name: 'ç«œ', desc: 'é£›è»Š+æ–œã‚1ãƒã‚¹', moves: [[1,2,1],[2,0,2],[1,2,1]], wide: true, wideData: [[1,0,1,0,1],[0,1,1,1,0],[1,1,0,1,1],[0,1,1,1,0],[1,0,1,0,1]] },
        { name: 'é¦¬', desc: 'è§’+ç¸¦æ¨ª1ãƒã‚¹', moves: [[2,1,2],[1,0,1],[2,1,2]], wide: true, wideData: [[1,0,1,0,1],[0,1,1,1,0],[1,1,0,1,1],[0,1,1,1,0],[1,0,1,0,1]] },
      ];

      helpEl.innerHTML = '';
      for (const p of pieces) {
        const div = document.createElement('div');
        div.className = 'piece-info';

        let grid;
        if (p.wide && p.wideData) {
          grid = '<div class="move-grid wide">';
          for (let r = 0; r < 5; r++) {
            for (let c = 0; c < 5; c++) {
              const isCenter = r === 2 && c === 2;
              const v = p.wideData[r][c];
              let cls = 'move-cell';
              if (isCenter) cls += ' center';
              else if (v === 1) cls += ' can';
              else if (v === 2) cls += ' far';
              grid += `<div class="${cls}">${isCenter ? p.name : (v === 2 ? 'â†‘' : '')}</div>`;
            }
          }
          grid += '</div>';
        } else if (p.special === 'knight') {
          grid = '<div class="move-grid">';
          const layout = [[1,0,1],[0,0,0],[0,0,0],[0,1,0]];
          for (let r = 0; r < 4; r++) {
            for (let c = 0; c < 3; c++) {
              const isCenter = r === 3 && c === 1;
              const v = layout[r][c];
              let cls = 'move-cell';
              if (isCenter) cls += ' center';
              else if (v === 1) cls += ' can';
              grid += `<div class="${cls}">${isCenter ? p.name : ''}</div>`;
            }
          }
          grid += '</div>';
        } else {
          grid = '<div class="move-grid">';
          for (let r = 0; r < 3; r++) {
            for (let c = 0; c < 3; c++) {
              const isCenter = r === 1 && c === 1;
              const v = p.moves[r][c];
              let cls = 'move-cell';
              if (isCenter) cls += ' center';
              else if (v === 1) cls += ' can';
              else if (v === 2) cls += ' far';
              grid += `<div class="${cls}">${isCenter ? p.name : (v === 2 ? 'â†‘' : '')}</div>`;
            }
          }
          grid += '</div>';
        }

        div.innerHTML = `<div class="name">${p.name}</div>${grid}${p.desc ? `<div class="moves">${p.desc}</div>` : ''}`;
        helpEl.appendChild(div);
      }
    }

    // åˆæœŸåŒ–
    initBoard();
  </script>
</body>
</html>
