<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>äººç‹¼ã‚²ãƒ¼ãƒ </title>
  <link rel="stylesheet" href="common.css">
  <script src="common.js" defer></script>
  <style>
    /* åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    body {
      background: #f5f0fa;
      transition: background 0.3s;
    }

    body.night-mode {
      background: #1a1030;
    }

    .screen {
      display: none;
      max-width: 420px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(107, 91, 122, 0.15);
    }

    .screen.active {
      display: block;
    }

    body.night-mode .screen {
      background: #2d1f3d;
      color: #f5f0fa;
    }

    h2 {
      font-size: 1.5rem;
      color: #6b5b7a;
      margin-bottom: 16px;
      text-align: center;
    }

    body.night-mode h2 {
      color: #d4c5e2;
    }

    /* ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 16px;
    }

    .btn-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .btn-row.full {
      grid-template-columns: 1fr;
    }

    /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    button {
      background: linear-gradient(135deg, #a78bbd, #8b6fa8);
      color: white;
      border: none;
      padding: 14px 20px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      min-height: 52px;
      transition: transform 0.1s;
    }

    button:hover {
      opacity: 0.9;
    }

    button:active {
      transform: scale(0.95);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button.selected {
      background: linear-gradient(135deg, #6b5b7a, #5a4a68);
      box-shadow: 0 0 10px rgba(107, 91, 122, 0.5);
    }

    /* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ */
    #screen-title {
      text-align: center;
    }

    .title-emoji {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    .title-text {
      font-size: 2rem;
      color: #6b5b7a;
      margin-bottom: 16px;
      font-weight: bold;
    }

    body.night-mode .title-text {
      color: #d4c5e2;
    }

    /* ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ */
    .setup-section {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e8e0f0;
    }

    body.night-mode .setup-section {
      border-color: #3d2d4d;
    }

    .setup-label {
      font-weight: bold;
      color: #6b5b7a;
      margin-bottom: 10px;
      display: block;
    }

    body.night-mode .setup-label {
      color: #d4c5e2;
    }

    .cpu-status {
      font-size: 0.9rem;
      color: #9b8ab8;
      margin-top: 4px;
    }

    body.night-mode .cpu-status {
      color: #c5b8d0;
    }

    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åå…¥åŠ› */
    .player-input-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }

    input[type="text"] {
      padding: 10px;
      border: 2px solid #e8e0f0;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #6b5b7a;
      background: white;
    }

    body.night-mode input[type="text"] {
      background: #3d2d4d;
      border-color: #5a4a68;
      color: #f5f0fa;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #a78bbd;
    }

    input[type="text"]:disabled {
      background: #f0f0f0;
      color: #999;
    }

    body.night-mode input[type="text"]:disabled {
      background: #1a1030;
      color: #666;
    }

    /* å½¹è·è¡¨ç¤º */
    .role-display {
      text-align: center;
      padding: 30px 20px;
      background: linear-gradient(135deg, #a78bbd, #8b6fa8);
      border-radius: 12px;
      color: white;
      margin: 20px 0;
    }

    .role-emoji {
      font-size: 3rem;
      margin-bottom: 10px;
    }

    .role-name {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .role-ruby {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 16px;
    }

    .role-description {
      font-size: 0.9rem;
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .role-team {
      font-size: 0.85rem;
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 12px;
      border-radius: 8px;
    }

    /* ã‚¢ãƒ©ãƒ¼ãƒˆ */
    .alert {
      background: #ffe8e8;
      color: #d32f2f;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 0.9rem;
    }

    body.night-mode .alert {
      background: #3d1f1f;
      color: #ff9999;
    }

    /* ç”Ÿå­˜è€…ä¸€è¦§ */
    .player-list {
      background: #f5f0fa;
      border-radius: 10px;
      padding: 16px;
      margin: 16px 0;
    }

    body.night-mode .player-list {
      background: #3d2d4d;
    }

    .player-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      font-size: 0.95rem;
      color: #6b5b7a;
    }

    body.night-mode .player-item {
      color: #d4c5e2;
    }

    .player-item.dead {
      opacity: 0.6;
      color: #999;
    }

    .player-status {
      font-size: 1.2rem;
    }

    /* å¹ãå‡ºã— */
    .speech-bubble {
      background: #e8e0f0;
      border-radius: 12px;
      padding: 12px 14px;
      margin: 10px 0;
      position: relative;
      color: #6b5b7a;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    body.night-mode .speech-bubble {
      background: #3d2d4d;
      color: #d4c5e2;
    }

    .speech-bubble::before {
      content: '';
      position: absolute;
      left: -8px;
      top: 10px;
      width: 0;
      height: 0;
      border-right: 8px solid #e8e0f0;
      border-top: 6px solid transparent;
      border-bottom: 6px solid transparent;
    }

    body.night-mode .speech-bubble::before {
      border-right-color: #3d2d4d;
    }

    .speaker-name {
      font-weight: bold;
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    /* æŠ•ç¥¨çµæœ */
    .vote-result {
      background: #f5f0fa;
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
      font-size: 0.9rem;
      color: #6b5b7a;
    }

    body.night-mode .vote-result {
      background: #3d2d4d;
      color: #d4c5e2;
    }

    /* ã‚²ãƒ¼ãƒ çµ‚äº†ç”»é¢ */
    .result-screen {
      text-align: center;
    }

    .result-title {
      font-size: 2rem;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .result-emoji {
      font-size: 3rem;
      margin-bottom: 10px;
    }

    .final-roles {
      background: #f5f0fa;
      border-radius: 10px;
      padding: 16px;
      margin: 20px 0;
      text-align: left;
    }

    body.night-mode .final-roles {
      background: #3d2d4d;
    }

    .role-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e8e0f0;
      font-size: 0.9rem;
      color: #6b5b7a;
    }

    body.night-mode .role-item {
      border-color: #5a4a68;
      color: #d4c5e2;
    }

    .role-item:last-child {
      border-bottom: none;
    }

    .role-name-result {
      font-weight: bold;
    }

    /* æƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆ */
    .info-text {
      color: #9b8ab8;
      font-size: 0.85rem;
      margin: 12px 0;
      text-align: center;
    }

    body.night-mode .info-text {
      color: #c5b8d0;
    }

    /* ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤º */
    .phase-title {
      font-size: 1.3rem;
      color: #6b5b7a;
      margin-bottom: 16px;
      text-align: center;
      font-weight: bold;
    }

    body.night-mode .phase-title {
      color: #d4c5e2;
    }

    /* è©³ç´°ãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠ */
    .player-selection {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 16px 0;
    }

    .player-btn {
      padding: 12px 8px;
      font-size: 0.9rem;
    }

    .player-btn.dead {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .player-btn.protected {
      opacity: 0.5;
    }

    /* èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ */
    .instruction {
      color: #6b5b7a;
      font-size: 0.9rem;
      margin-bottom: 12px;
      line-height: 1.6;
    }

    body.night-mode .instruction {
      color: #d4c5e2;
    }

    /* æ—¥æ•°è¡¨ç¤º */
    .day-number {
      text-align: center;
      color: #9b8ab8;
      font-size: 0.85rem;
      margin-top: 12px;
    }

    body.night-mode .day-number {
      color: #c5b8d0;
    }
  </style>
</head>
<body>
  <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
  <div id="screen-title" class="screen active">
    <div class="title-emoji">ğŸº</div>
    <div class="title-text">äººç‹¼ã‚²ãƒ¼ãƒ </div>
    <details class="how-to-play">
      <summary>éŠã³æ–¹</summary>
      <div class="content">
        <ul>
          <li>æ‘äººãƒãƒ¼ãƒ ã¨<ruby>äººç‹¼<rt>ã˜ã‚“ã‚ã†</rt></ruby>ãƒãƒ¼ãƒ ã«åˆ†ã‹ã‚Œã¾ã™</li>
          <li>å¤œï¼š<ruby>äººç‹¼<rt>ã˜ã‚“ã‚ã†</rt></ruby>ãŒæ‘äººã‚’1äººå€’ã—ã¾ã™</li>
          <li>æ˜¼ï¼šã¿ã‚“ãªã§è©±ã—åˆã„ã€æ€ªã—ã„äººã‚’1äºº<ruby>è¿½æ”¾<rt>ã¤ã„ã»ã†</rt></ruby>ã—ã¾ã™</li>
          <li>æ‘äººãƒãƒ¼ãƒ ï¼š<ruby>äººç‹¼<rt>ã˜ã‚“ã‚ã†</rt></ruby>ã‚’å…¨å“¡<ruby>è¿½æ”¾<rt>ã¤ã„ã»ã†</rt></ruby>ã™ã‚Œã°å‹ã¡</li>
          <li><ruby>äººç‹¼<rt>ã˜ã‚“ã‚ã†</rt></ruby>ãƒãƒ¼ãƒ ï¼š<ruby>äººç‹¼<rt>ã˜ã‚“ã‚ã†</rt></ruby>ã®æ•°ãŒæ‘äººä»¥ä¸Šã«ãªã‚Œã°å‹ã¡</li>
        </ul>
      </div>
    </details>
    <button class="btn btn-primary" onclick="showScreen('screen-setup')">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  </div>

  <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ -->
  <div id="screen-setup" class="screen">
    <h2>ã‚²ãƒ¼ãƒ è¨­å®š</h2>

    <div class="setup-section">
      <label class="setup-label">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ•°</label>
      <div class="btn-row">
        <button onclick="setPlayerCount(4)">4äºº</button>
        <button onclick="setPlayerCount(5)">5äºº</button>
        <button onclick="setPlayerCount(6)">6äºº</button>
        <button onclick="setPlayerCount(7)">7äºº</button>
        <button onclick="setPlayerCount(8)">8äºº</button>
      </div>
    </div>

    <div class="setup-section">
      <label class="setup-label">CPU<ruby>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼<rt>ã·ã‚Œã„ã‚„ãƒ¼</rt></ruby></label>
      <div id="cpu-buttons" class="btn-row"></div>
      <div id="cpu-status" class="cpu-status"></div>
    </div>

    <div class="setup-section">
      <label class="setup-label">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åå‰</label>
      <div id="player-names" class="player-input-group"></div>
    </div>

    <div class="btn-group">
      <button class="btn btn-primary" onclick="startGame()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
  </div>

  <!-- å½¹è·ç¢ºèªç”»é¢ -->
  <div id="screen-role-check" class="screen">
    <div class="alert">ğŸ“± ä»–ã®äººã«ç”»é¢ã‚’è¦‹ã›ãªã„ã§ãã ã•ã„</div>
    <h2 id="role-check-label"></h2>
    <p class="instruction" id="role-check-instruction"></p>
    <button class="btn btn-primary" id="role-check-btn" onclick="showRole()">ã‚¿ãƒƒãƒ—ã—ã¦<ruby>å½¹è·<rt>ã‚„ãã—ã‚‡ã</rt></ruby>ã‚’è¦‹ã‚‹</button>
    <div id="role-display-area"></div>
  </div>

  <!-- å¤œãƒ•ã‚§ãƒ¼ã‚ºç”»é¢ -->
  <div id="screen-night" class="screen">
    <h2 class="phase-title">ğŸŒ™ å¤œã«ãªã‚Šã¾ã—ãŸ</h2>
    <div id="night-actions"></div>
    <p class="day-number" id="day-info"></p>
  </div>

  <!-- æ˜¼ãƒ•ã‚§ãƒ¼ã‚ºç”»é¢ -->
  <div id="screen-day" class="screen">
    <h2 class="phase-title">â˜€ï¸ æœã«ãªã‚Šã¾ã—ãŸ</h2>
    <div id="day-message"></div>
    <div id="player-status-list"></div>
    <div id="cpu-speeches"></div>
    <button class="btn btn-primary" onclick="showScreen('screen-vote')">æŠ•ç¥¨ã¸</button>
  </div>

  <!-- æŠ•ç¥¨ç”»é¢ -->
  <div id="screen-vote" class="screen">
    <h2>èª°ã‚’<ruby>è¿½æ”¾<rt>ã¤ã„ã»ã†</rt></ruby>ã—ã¾ã™ã‹ï¼Ÿ</h2>
    <p class="instruction" id="vote-instruction"></p>
    <div id="vote-options" class="player-selection"></div>
    <button class="btn btn-primary" id="vote-btn" onclick="executeVote()" disabled>æŠ•ç¥¨</button>
  </div>

  <!-- è¿½æ”¾çµæœç”»é¢ -->
  <div id="screen-result" class="screen">
    <h2>æŠ•ç¥¨çµæœ</h2>
    <div id="vote-count-list"></div>
    <div id="execution-message" style="margin: 20px 0; padding: 16px; background: #f5f0fa; border-radius: 8px; text-align: center;"></div>
    <button class="btn btn-primary" id="next-btn" onclick="nextPhase()">æ¬¡ã¸</button>
  </div>

  <!-- ã‚²ãƒ¼ãƒ çµ‚äº†ç”»é¢ -->
  <div id="screen-gameover" class="screen result-screen">
    <div class="result-emoji" id="final-emoji"></div>
    <div class="result-title" id="final-title"></div>
    <div class="final-roles" id="final-role-list"></div>
    <button class="btn btn-primary" onclick="resetGame()">ã‚‚ã†ä¸€åº¦éŠã¶</button>
  </div>

  <script>
    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†
    const state = {
      playerCount: 5,
      cpuCount: 0,
      players: [],
      day: 1,
      phase: 'title',
      roleCheckIndex: 0,
      nightKillTarget: -1,
      nightProtectTarget: -1,
      votes: {},
      killedLastNight: -1,
      executedPlayer: -1,
      nightActionQueue: [],
      nightActionIndex: 0,
    };

    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
    function showScreen(id) {
      document.querySelectorAll('[id^="screen-"]').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');

      // å¤œãƒ¢ãƒ¼ãƒ‰ã®èƒŒæ™¯è‰²åˆ‡ã‚Šæ›¿ãˆ
      if (id === 'screen-night') {
        document.body.classList.add('night-mode');
      } else {
        document.body.classList.remove('night-mode');
      }
    }

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°è¨­å®š
    function setPlayerCount(count) {
      state.playerCount = count;
      state.cpuCount = 0;
      updateCpuButtons();
      updatePlayerInputs();
    }

    // CPUæ•°ãƒœã‚¿ãƒ³ã®æ›´æ–°
    function updateCpuButtons() {
      const container = document.getElementById('cpu-buttons');
      container.innerHTML = '';
      for (let i = 0; i < state.playerCount; i++) {
        const btn = document.createElement('button');
        btn.textContent = i + 'äºº';
        btn.classList.toggle('selected', i === state.cpuCount);
        btn.onclick = () => { state.cpuCount = i; updateCpuButtons(); updatePlayerInputs(); };
        container.appendChild(btn);
      }
      updateCpuStatus();
    }

    // CPUçŠ¶æ…‹ã®è¡¨ç¤º
    function updateCpuStatus() {
      const status = document.getElementById('cpu-status');
      if (state.cpuCount === 0) {
        status.textContent = 'å…¨å“¡äººé–“ï¼ˆãƒ‘ã‚¹ãƒ—ãƒ¬ã‚¤ï¼‰';
      } else {
        status.textContent = `CPU${state.cpuCount}äºº`;
      }
    }

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åå…¥åŠ›ã®æ›´æ–°
    function updatePlayerInputs() {
      const container = document.getElementById('player-names');
      container.innerHTML = '';
      for (let i = 0; i < state.playerCount; i++) {
        const isCpu = i >= state.playerCount - state.cpuCount;
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i + 1}`;
        input.disabled = isCpu;
        input.value = state.players[i]?.name || (isCpu ? `CPU${i - (state.playerCount - state.cpuCount) + 1}` : `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i + 1}`);
        input.onchange = (e) => {
          if (!state.players[i]) state.players[i] = { id: i, seerResults: [], lastProtected: -1 };
          state.players[i].name = e.target.value;
        };
        container.appendChild(input);
      }
    }

    // ã‚²ãƒ¼ãƒ é–‹å§‹
    function startGame() {
      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæœŸåŒ–
      state.players = [];
      for (let i = 0; i < state.playerCount; i++) {
        const isCpu = i >= state.playerCount - state.cpuCount;
        const nameInput = document.querySelectorAll('#player-names input')[i];
        state.players.push({
          id: i,
          name: nameInput.value || (isCpu ? `CPU${i - (state.playerCount - state.cpuCount) + 1}` : `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i + 1}`),
          role: '',
          isAlive: true,
          isCpu: isCpu,
          seerResults: [],
          lastProtected: -1,
        });
      }

      // å½¹è·é…å¸ƒ
      assignRoles();

      // å½¹è·ç¢ºèªãƒ•ã‚§ãƒ¼ã‚ºã¸
      state.roleCheckIndex = 0;
      showRoleCheckScreen();
    }

    // å½¹è·é…å¸ƒ
    function assignRoles() {
      const n = state.playerCount;
      const configs = {
        4: { werewolf: 1, seer: 0, knight: 0 },
        5: { werewolf: 1, seer: 1, knight: 0 },
        6: { werewolf: 1, seer: 1, knight: 1 },
        7: { werewolf: 2, seer: 1, knight: 0 },
        8: { werewolf: 2, seer: 1, knight: 1 },
      };
      const conf = configs[n];

      let roles = [];
      for (let i = 0; i < conf.werewolf; i++) roles.push('werewolf');
      for (let i = 0; i < conf.seer; i++) roles.push('seer');
      for (let i = 0; i < conf.knight; i++) roles.push('knight');
      while (roles.length < n) roles.push('villager');

      // Fisher-Yatesã‚·ãƒ£ãƒƒãƒ•ãƒ«
      for (let i = roles.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [roles[i], roles[j]] = [roles[j], roles[i]];
      }

      state.players.forEach((p, i) => { p.role = roles[i]; });
    }

    // å½¹è·ç¢ºèªç”»é¢è¡¨ç¤º
    function showRoleCheckScreen() {
      if (state.roleCheckIndex >= state.playerCount) {
        // å…¨å“¡ç¢ºèªå®Œäº†
        startNight();
        return;
      }

      const player = state.players[state.roleCheckIndex];
      const label = document.getElementById('role-check-label');
      const instruction = document.getElementById('role-check-instruction');

      if (player.isCpu) {
        label.textContent = 'ï¼ˆCPUï¼‰ã®å½¹è·ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™';
        instruction.textContent = '';
        document.getElementById('role-check-btn').style.display = 'none';
        document.getElementById('role-display-area').innerHTML = '';
        state.roleCheckIndex++;
        setTimeout(() => showRoleCheckScreen(), 1500);
      } else {
        label.textContent = `${player.name}ã•ã‚“ã€æº–å‚™ãŒã§ããŸã‚‰ç”»é¢ã‚’è¦‹ã¦ãã ã•ã„`;
        instruction.textContent = '';
        document.getElementById('role-check-btn').style.display = 'block';
        document.getElementById('role-display-area').innerHTML = '';
      }

      showScreen('screen-role-check');
    }

    // å½¹è·è¡¨ç¤º
    function showRole() {
      const player = state.players[state.roleCheckIndex];
      const roleEmojis = { werewolf: 'ğŸº', seer: 'ğŸ”®', knight: 'ğŸ›¡ï¸', villager: 'ğŸ‘¤' };
      const roleNames = { werewolf: 'äººç‹¼', seer: 'å ã„å¸«', knight: 'é¨å£«', villager: 'æ‘äºº' };
      const roleDescriptions = {
        werewolf: 'å¤œã«æ‘äººã‚’1äººå€’ã™',
        seer: 'å¤œã«èª°ã‹ã®æ­£ä½“ã‚’å ãˆã‚‹',
        knight: 'å¤œã«èª°ã‹ã‚’å®ˆã‚‹',
        villager: 'ç‰¹æ®Šèƒ½åŠ›ã¯ãªã„',
      };

      const werewolfTeam = state.players.filter(p => p.role === 'werewolf' && p.id !== player.id && p.isAlive);
      const teamInfo = player.role === 'werewolf' && werewolfTeam.length > 0
        ? `<div class="role-team"><ruby>äººç‹¼<rt>ã˜ã‚“ã‚ã†</rt></ruby>ä»²é–“: ${werewolfTeam.map(p => p.name).join(', ')}</div>`
        : '';

      const html = `
        <div class="role-display">
          <div>ã‚ãªãŸã®<ruby>å½¹è·<rt>ã‚„ãã—ã‚‡ã</rt></ruby>ã¯...</div>
          <div style="margin: 16px 0;">
            <div class="role-emoji">${roleEmojis[player.role]}</div>
            <div class="role-name">${roleNames[player.role]}</div>
            <div class="role-ruby" style="font-size: 0.75rem;">${player.role === 'werewolf' ? 'ã˜ã‚“ã‚ã†' : player.role === 'seer' ? 'ã†ã‚‰ãªã„ã—' : player.role === 'knight' ? 'ãã—' : 'ã‚€ã‚‰ã³ã¨'}</div>
          </div>
          <div class="role-description">${roleDescriptions[player.role]}</div>
          ${teamInfo}
        </div>
      `;
      document.getElementById('role-display-area').innerHTML = html;
      document.getElementById('role-check-btn').textContent = 'ç¢ºèªã—ã¾ã—ãŸ';
      document.getElementById('role-check-btn').onclick = () => {
        state.roleCheckIndex++;
        showRoleCheckScreen();
      };
    }

    // å¤œãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹
    function startNight() {
      state.phase = 'night';
      state.day = 1;
      state.nightKillTarget = -1;
      state.nightProtectTarget = -1;
      state.nightActionQueue = state.players.filter(p => !p.isCpu);
      state.nightActionIndex = 0;

      showNightActions();
    }

    // å¤œãƒ•ã‚§ãƒ¼ã‚ºç”»é¢
    function showNightActions() {
      document.getElementById('day-info').textContent = `${state.day}æ—¥ç›®ã®å¤œ`;

      if (state.nightActionIndex >= state.nightActionQueue.length) {
        // äººé–“ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•å®Œäº†ã€CPUè¡Œå‹•å®Ÿè¡Œ
        cpuNightActions();
        applyNightKill();
        showDayPhase();
        return;
      }

      const player = state.nightActionQueue[state.nightActionIndex];
      const actionsHtml = document.getElementById('night-actions');
      actionsHtml.innerHTML = '';

      if (player.role === 'werewolf') {
        // äººç‹¼ã®è¡Œå‹•
        const targets = state.players.filter(p => p.isAlive && p.role !== 'werewolf');
        let html = `<p class="instruction">ğŸº <ruby>äººç‹¼<rt>ã˜ã‚“ã‚ã†</rt></ruby>ã•ã‚“ã€èª°ã‚’å€’ã—ã¾ã™ã‹ï¼Ÿ</p><div class="player-selection">`;
        targets.forEach(t => {
          html += `<button class="player-btn" onclick="selectKillTarget(${t.id})">${t.name}</button>`;
        });
        html += `</div><button class="btn btn-primary" onclick="confirmNightAction()" id="confirm-btn" disabled>æ±ºå®š</button>`;
        actionsHtml.innerHTML = html;
      } else if (player.role === 'seer') {
        // å ã„å¸«ã®è¡Œå‹•
        const targets = state.players.filter(p => p.isAlive && p.id !== player.id);
        let html = `<p class="instruction">ğŸ”® å ã„å¸«ã•ã‚“ã€èª°ã‚’å ã„ã¾ã™ã‹ï¼Ÿ</p><div class="player-selection">`;
        targets.forEach(t => {
          html += `<button class="player-btn" onclick="selectSeerTarget(${t.id})">${t.name}</button>`;
        });
        html += `</div><button class="btn btn-primary" onclick="confirmSeerAction()" id="confirm-btn" disabled>æ±ºå®š</button>`;
        actionsHtml.innerHTML = html;
      } else if (player.role === 'knight') {
        // é¨å£«ã®è¡Œå‹•
        const targets = state.players.filter(p => p.isAlive && p.id !== player.id && p.id !== player.lastProtected);
        let html = `<p class="instruction">ğŸ›¡ï¸ é¨å£«ã•ã‚“ã€èª°ã‚’å®ˆã‚Šã¾ã™ã‹ï¼Ÿ</p><div class="player-selection">`;
        targets.forEach(t => {
          html += `<button class="player-btn" onclick="selectProtectTarget(${t.id})">${t.name}</button>`;
        });
        html += `</div><button class="btn btn-primary" onclick="confirmProtectAction()" id="confirm-btn" disabled>æ±ºå®š</button>`;
        actionsHtml.innerHTML = html;
      }

      showScreen('screen-night');
    }

    let selectedKillTarget = -1;
    let selectedSeerTarget = -1;
    let selectedProtectTarget = -1;

    function selectKillTarget(id) {
      selectedKillTarget = id;
      document.querySelectorAll('.player-btn').forEach(btn => btn.classList.remove('selected'));
      event.target.classList.add('selected');
      document.getElementById('confirm-btn').disabled = false;
    }

    function confirmNightAction() {
      state.nightKillTarget = selectedKillTarget;
      selectedKillTarget = -1;
      state.nightActionIndex++;
      showNightActions();
    }

    function selectSeerTarget(id) {
      selectedSeerTarget = id;
      document.querySelectorAll('.player-btn').forEach(btn => btn.classList.remove('selected'));
      event.target.classList.add('selected');
      document.getElementById('confirm-btn').disabled = false;
    }

    function confirmSeerAction() {
      const player = state.nightActionQueue[state.nightActionIndex];
      const target = state.players[selectedSeerTarget];
      const isWerewolf = target.role === 'werewolf';
      player.seerResults.push({ targetId: selectedSeerTarget, isWerewolf: isWerewolf });

      const resultText = isWerewolf ? 'ğŸº <ruby>äººç‹¼<rt>ã˜ã‚“ã‚ã†</rt></ruby>ã§ã™ï¼' : 'æ‘äººãƒãƒ¼ãƒ ã§ã—ãŸ';
      document.getElementById('night-actions').innerHTML = `
        <p class="instruction">${target.name}ã•ã‚“ã‚’å ã„ã¾ã—ãŸã€‚${resultText}</p>
        <button class="btn btn-primary" onclick="nextSeerAction()">ã‚ã‹ã‚Šã¾ã—ãŸ</button>
      `;
    }

    function nextSeerAction() {
      selectedSeerTarget = -1;
      state.nightActionIndex++;
      showNightActions();
    }

    function selectProtectTarget(id) {
      selectedProtectTarget = id;
      document.querySelectorAll('.player-btn').forEach(btn => btn.classList.remove('selected'));
      event.target.classList.add('selected');
      document.getElementById('confirm-btn').disabled = false;
    }

    function confirmProtectAction() {
      const player = state.nightActionQueue[state.nightActionIndex];
      state.nightProtectTarget = selectedProtectTarget;
      player.lastProtected = selectedProtectTarget;
      selectedProtectTarget = -1;
      state.nightActionIndex++;
      showNightActions();
    }

    // CPUå¤œè¡Œå‹•
    function cpuNightActions() {
      const werewolfCpu = state.players.find(p => p.isCpu && p.isAlive && p.role === 'werewolf');
      if (werewolfCpu && state.nightKillTarget === -1) {
        const targets = state.players.filter(p => p.isAlive && p.role !== 'werewolf');
        if (targets.length > 0) {
          state.nightKillTarget = targets[Math.floor(Math.random() * targets.length)].id;
        }
      }

      const seerCpu = state.players.find(p => p.isCpu && p.isAlive && p.role === 'seer');
      if (seerCpu) {
        const alreadyChecked = seerCpu.seerResults.map(r => r.targetId);
        const candidates = state.players.filter(p => p.isAlive && p.id !== seerCpu.id && !alreadyChecked.includes(p.id));
        if (candidates.length > 0) {
          const target = candidates[Math.floor(Math.random() * candidates.length)];
          seerCpu.seerResults.push({ targetId: target.id, isWerewolf: target.role === 'werewolf' });
        }
      }

      const knightCpu = state.players.find(p => p.isCpu && p.isAlive && p.role === 'knight');
      if (knightCpu && state.nightProtectTarget === -1) {
        const candidates = state.players.filter(p => p.isAlive && p.id !== knightCpu.id && p.id !== knightCpu.lastProtected);
        if (candidates.length > 0) {
          const target = candidates[Math.floor(Math.random() * candidates.length)];
          state.nightProtectTarget = target.id;
          knightCpu.lastProtected = target.id;
        }
      }
    }

    // å¤œé–“ã‚­ãƒ«ã®å®Ÿè¡Œ
    function applyNightKill() {
      if (state.nightKillTarget !== -1 && state.nightKillTarget !== state.nightProtectTarget) {
        state.players[state.nightKillTarget].isAlive = false;
        state.killedLastNight = state.nightKillTarget;
      } else {
        state.killedLastNight = -1;
      }
      state.nightKillTarget = -1;
      state.nightProtectTarget = -1;
    }

    // æ˜¼ãƒ•ã‚§ãƒ¼ã‚º
    function showDayPhase() {
      state.phase = 'day';

      // å¤œã®çµæœ
      const dayMessageDiv = document.getElementById('day-message');
      if (state.killedLastNight !== -1) {
        dayMessageDiv.innerHTML = `<p class="instruction" style="color: #d32f2f; font-weight: bold; margin: 16px 0;">${state.players[state.killedLastNight].name}ã•ã‚“ãŒå€’ã•ã‚Œã¾ã—ãŸ ğŸ˜¢</p>`;
      } else {
        dayMessageDiv.innerHTML = `<p class="instruction" style="color: #4caf50; font-weight: bold; margin: 16px 0;">ä»Šå¤œã¯èª°ã‚‚å€’ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼</p>`;
      }

      // ç”Ÿå­˜è€…ä¸€è¦§
      const playerList = document.getElementById('player-status-list');
      let html = `<div class="player-list">`;
      state.players.forEach(p => {
        const statusEmoji = p.isAlive ? 'ğŸ‘¤' : 'ğŸ’€';
        const deadClass = !p.isAlive ? 'dead' : '';
        html += `<div class="player-item ${deadClass}"><span class="player-status">${statusEmoji}</span> <span>${p.name}</span></div>`;
      });
      html += `</div>`;
      playerList.innerHTML = html;

      // CPUç™ºè¨€
      const speechesDiv = document.getElementById('cpu-speeches');
      let speechesHtml = '';
      const cpuPlayers = state.players.filter(p => p.isCpu && p.isAlive);
      cpuPlayers.forEach(cpu => {
        const speech = getCpuSpeech(cpu);
        speechesHtml += `<div class="speech-bubble"><div class="speaker-name">${cpu.name}</div>${speech}</div>`;
      });
      speechesDiv.innerHTML = speechesHtml;

      showScreen('screen-day');
    }

    // CPUç™ºè¨€ç”Ÿæˆ
    function getCpuSpeech(cpu) {
      if (cpu.role === 'werewolf') {
        const villagers = state.players.filter(p => p.isAlive && p.role !== 'werewolf');
        if (villagers.length === 0) return 'å…¨å“¡å€’ã—ã¦ã—ã¾ã£ãŸ...';
        const target = villagers[Math.floor(Math.random() * villagers.length)];
        const wolfLines = [
          `${target.name}ã•ã‚“ãŒæ€ªã—ã„ã¨æ€ã„ã¾ã™`,
          `ç§ã¯æ‘äººã§ã™ã€‚${target.name}ã•ã‚“ã‚’<ruby>è¿½æ”¾<rt>ã¤ã„ã»ã†</rt></ruby>ã™ã¹ãã§ã™`,
          `ã¿ã‚“ãªã€è½ã¡ç€ã„ã¦è€ƒãˆã‚ˆã†ã€‚${target.name}ã•ã‚“ãŒæ€ªã—ã„`,
          `æ˜¨æ—¥ã®å¤œã€${target.name}ã•ã‚“ãŒã†ã‚ã¤ã„ã¦ã„ã‚‹ã®ã‚’è¦‹ãŸæ°—ãŒã—ã¾ã™`,
        ];
        return wolfLines[Math.floor(Math.random() * wolfLines.length)];
      } else if (cpu.role === 'seer') {
        const lastResult = cpu.seerResults[cpu.seerResults.length - 1];
        if (lastResult) {
          const targetName = state.players[lastResult.targetId].name;
          if (lastResult.isWerewolf) {
            return `${targetName}ã•ã‚“ã‚’å ã„ã¾ã—ãŸã€‚ğŸº <ruby>äººç‹¼<rt>ã˜ã‚“ã‚ã†</rt></ruby>ã§ã™ï¼ã¿ã‚“ãªä¿¡ã˜ã¦ãã ã•ã„`;
          } else {
            return `${targetName}ã•ã‚“ã‚’å ã„ã¾ã—ãŸã€‚æ‘äººãƒãƒ¼ãƒ ã§ã—ãŸ`;
          }
        }
      }

      // æ‘äººã¾ãŸã¯ã¾ã å ã£ã¦ã„ãªã„å ã„å¸«
      const allPlayers = state.players.filter(p => p.isAlive && p.id !== cpu.id);
      if (allPlayers.length === 0) return 'ã“ã‚Œã¯...';
      const target = allPlayers[Math.floor(Math.random() * allPlayers.length)];
      const villagerLines = [
        `${target.name}ã•ã‚“ã€æ˜¨å¤œã¯ã©ã“ã«ã„ã¾ã—ãŸã‹ï¼Ÿ`,
        `ç§ã«ã¯å ã„å¸«ã®åŠ›ã¯ãªã„ã‘ã©ã€${target.name}ã•ã‚“ãŒæ€ªã—ã„æ°—ãŒã—ã¾ã™`,
        `ã¿ã‚“ãªã§åŠ›ã‚’åˆã‚ã›ã¦<ruby>äººç‹¼<rt>ã˜ã‚“ã‚ã†</rt></ruby>ã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼`,
        `<ruby>äººç‹¼<rt>ã˜ã‚“ã‚ã†</rt></ruby>ã¯çµ¶å¯¾ã«æ‘ã®ä¸­ã«ã„ã‚‹ï¼ã‚ˆãè€ƒãˆã‚ˆã†`,
        `${target.name}ã•ã‚“ã€ãªã‚“ã‹æ…‹åº¦ãŒãŠã‹ã—ããªã„ï¼Ÿ`,
      ];
      return villagerLines[Math.floor(Math.random() * villagerLines.length)];
    }

    // æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚º
    function startVotePhase() {
      state.votes = {};
      const votingPlayers = state.players.filter(p => !p.isCpu && p.isAlive);

      if (votingPlayers.length === 0) {
        // CPUåŒå£«ã®æŠ•ç¥¨ã®ã¿
        cpuVote();
        showVoteResult();
        return;
      }

      const instruction = document.getElementById('vote-instruction');
      instruction.textContent = '';
      const optionsDiv = document.getElementById('vote-options');
      let html = '';
      const targets = state.players.filter(p => p.isAlive);
      targets.forEach(t => {
        html += `<button class="player-btn" onclick="selectVoteTarget(${t.id})">${t.name}</button>`;
      });
      optionsDiv.innerHTML = html;

      showScreen('screen-vote');
    }

    let selectedVoteTarget = -1;

    function selectVoteTarget(id) {
      // è‡ªåˆ†ã«ã¯æŠ•ç¥¨ã§ããªã„
      const currentVoter = state.players.find(p => !p.isCpu && p.isAlive);
      if (currentVoter && id === currentVoter.id) return;

      selectedVoteTarget = id;
      document.querySelectorAll('.player-btn').forEach(btn => btn.classList.remove('selected'));
      event.target.classList.add('selected');
      document.getElementById('vote-btn').disabled = false;
    }

    function executeVote() {
      // æŠ•ç¥¨æ¸ˆã¿ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å–å¾—
      const voters = state.players.filter(p => !p.isCpu && p.isAlive);
      const currentVoter = voters.find(v => !state.votes.hasOwnProperty(v.id));

      if (!currentVoter) return;

      state.votes[currentVoter.id] = selectedVoteTarget;
      selectedVoteTarget = -1;

      // æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹å…¨å“¡æŠ•ç¥¨å®Œäº†
      const allVoted = voters.every(v => state.votes.hasOwnProperty(v.id));
      if (allVoted) {
        cpuVote();
        showVoteResult();
      } else {
        // æŠ•ç¥¨ç”»é¢ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('vote-options').querySelectorAll('.player-btn').forEach(btn => btn.classList.remove('selected'));
        document.getElementById('vote-btn').disabled = true;
      }
    }

    // CPUæŠ•ç¥¨
    function cpuVote() {
      const cpuPlayers = state.players.filter(p => p.isCpu && p.isAlive);
      cpuPlayers.forEach(cpu => {
        if (cpu.role === 'werewolf') {
          const targets = state.players.filter(p => p.isAlive && p.role !== 'werewolf');
          if (targets.length > 0) {
            state.votes[cpu.id] = targets[Math.floor(Math.random() * targets.length)].id;
          }
        } else {
          const targets = state.players.filter(p => p.isAlive && p.id !== cpu.id);
          if (targets.length > 0) {
            state.votes[cpu.id] = targets[Math.floor(Math.random() * targets.length)].id;
          }
        }
      });
    }

    // æŠ•ç¥¨çµæœè¡¨ç¤º
    function showVoteResult() {
      const voteCount = {};
      Object.values(state.votes).forEach(targetId => {
        voteCount[targetId] = (voteCount[targetId] || 0) + 1;
      });

      // æŠ•ç¥¨æ•°ä¸€è¦§
      let html = '';
      Object.entries(voteCount).forEach(([targetId, count]) => {
        html += `<div class="vote-result">${state.players[targetId].name}: ${count}ç¥¨</div>`;
      });
      document.getElementById('vote-count-list').innerHTML = html;

      // æœ€å¤šç¥¨ã®äººã‚’ç‰¹å®š
      let maxVotes = 0;
      let maxTargets = [];
      Object.entries(voteCount).forEach(([targetId, count]) => {
        if (count > maxVotes) {
          maxVotes = count;
          maxTargets = [parseInt(targetId)];
        } else if (count === maxVotes) {
          maxTargets.push(parseInt(targetId));
        }
      });

      // åŒç¥¨ã®å ´åˆã¯ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®š
      const executedId = maxTargets[Math.floor(Math.random() * maxTargets.length)];
      state.executedPlayer = executedId;
      state.players[executedId].isAlive = false;

      const executedPlayer = state.players[executedId];
      const roleNames = { werewolf: 'ğŸº äººç‹¼', seer: 'ğŸ”® å ã„å¸«', knight: 'ğŸ›¡ï¸ é¨å£«', villager: 'ğŸ‘¤ æ‘äºº' };
      const executionMsg = `
        <p style="margin-bottom: 12px; font-weight: bold; font-size: 1.1rem;">${executedPlayer.name}ã•ã‚“ãŒ<ruby>è¿½æ”¾<rt>ã¤ã„ã»ã†</rt></ruby>ã•ã‚Œã¾ã—ãŸï¼</p>
        <p style="margin-bottom: 0;">${executedPlayer.name}ã•ã‚“ã®æ­£ä½“ã¯...<br><span style="font-size: 1.2rem; font-weight: bold;">${roleNames[executedPlayer.role]}</span></p>
      `;
      document.getElementById('execution-message').innerHTML = executionMsg;

      // å‹åˆ©åˆ¤å®š
      const winner = checkWinCondition();
      if (winner) {
        document.getElementById('next-btn').textContent = 'ã‚²ãƒ¼ãƒ çµ‚äº†ã¸';
        document.getElementById('next-btn').onclick = () => showGameOver(winner);
      } else {
        document.getElementById('next-btn').textContent = 'æ¬¡ã®å¤œã¸';
        document.getElementById('next-btn').onclick = () => {
          state.day++;
          startNight();
        };
      }

      showScreen('screen-result');
    }

    // å‹åˆ©æ¡ä»¶ãƒã‚§ãƒƒã‚¯
    function checkWinCondition() {
      const aliveWolves = state.players.filter(p => p.isAlive && p.role === 'werewolf');
      const aliveVillagers = state.players.filter(p => p.isAlive && p.role !== 'werewolf');

      if (aliveWolves.length === 0) return 'villager';
      if (aliveWolves.length >= aliveVillagers.length) return 'werewolf';
      return null;
    }

    // ã‚²ãƒ¼ãƒ çµ‚äº†ç”»é¢
    function showGameOver(winner) {
      const emoji = winner === 'villager' ? 'ğŸ‰' : 'ğŸº';
      const title = winner === 'villager' ? 'æ‘äººãƒãƒ¼ãƒ ã®å‹åˆ©ï¼' : '<ruby>äººç‹¼<rt>ã˜ã‚“ã‚ã†</rt></ruby>ãƒãƒ¼ãƒ ã®å‹åˆ©ï¼';

      document.getElementById('final-emoji').textContent = emoji;
      document.getElementById('final-title').textContent = title;

      // å…¨å“¡ã®å½¹è·è¡¨ç¤º
      let rolesHtml = '';
      const roleNames = { werewolf: 'äººç‹¼', seer: 'å ã„å¸«', knight: 'é¨å£«', villager: 'æ‘äºº' };
      state.players.forEach(p => {
        const status = p.isAlive ? 'ç”Ÿå­˜' : 'æ­»äº¡';
        rolesHtml += `<div class="role-item"><span class="role-name-result">${p.name}</span><span>${roleNames[p.role]} (${status})</span></div>`;
      });
      document.getElementById('final-role-list').innerHTML = rolesHtml;

      showScreen('screen-gameover');
    }

    // ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    function resetGame() {
      state.playerCount = 5;
      state.cpuCount = 0;
      state.players = [];
      state.day = 1;
      state.phase = 'title';
      state.roleCheckIndex = 0;
      state.nightKillTarget = -1;
      state.nightProtectTarget = -1;
      state.votes = {};
      state.killedLastNight = -1;
      state.executedPlayer = -1;
      state.nightActionQueue = [];
      state.nightActionIndex = 0;
      document.body.classList.remove('night-mode');
      showScreen('screen-title');
      updateCpuButtons();
      updatePlayerInputs();
    }

    // æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚ºã¸é€²ã‚€
    function nextPhase() {
      startVotePhase();
    }

    // åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', () => {
      updateCpuButtons();
      updatePlayerInputs();
    });
  </script>
</body>
</html>
