<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ポケモンしりとり</title>
  <link rel="stylesheet" href="common.css">
  <script src="common.js" defer></script>
  <style>
    body { padding: 15px; }
    h1 { font-size: 1.8rem; margin-bottom: 10px; }
    .game-container { max-width: 400px; width: 100%; }
    .score-area { display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; }
    .score-box { background: #9b8ab8; padding: 8px 16px; border-radius: 6px; text-align: center; }
    .score-box .label { font-size: 0.7rem; color: #e8e0f0; }
    .score-box .value { font-size: 1.2rem; color: white; font-weight: bold; }
    .chain-display { background: #e8e0f0; padding: 12px; border-radius: 8px; margin-bottom: 10px; min-height: 60px; }
    .chain-display .current-char { font-size: 2rem; color: #6b5b7a; font-weight: bold; text-align: center; }
    .chain-display .hint { font-size: 0.85rem; color: #9b8ab8; text-align: center; margin-top: 5px; }
    .history { background: #f5f0fa; border-radius: 8px; padding: 10px; margin-bottom: 10px; max-height: 200px; overflow-y: auto; }
    .history-item { padding: 6px 10px; border-radius: 4px; margin-bottom: 4px; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
    .history-item.player { background: #d4f4d4; color: #2d5a2d; }
    .history-item.cpu { background: #d4d4f4; color: #2d2d5a; }
    .history-item .sprite { width: 40px; height: 40px; image-rendering: pixelated; flex-shrink: 0; }
    .history-item .info { flex: 1; }
    .history-item .name { font-weight: bold; }
    .history-item .char { color: #888; font-size: 0.8rem; }
    .input-area { display: flex; gap: 8px; margin-bottom: 10px; }
    .input-area input { flex: 1; padding: 12px; border: 2px solid #c5b8d8; border-radius: 6px; font-size: 1rem; outline: none; }
    .input-area input:focus { border-color: #7a6b8a; }
    .input-area input:disabled { background: #eee; }
    .message { background: #fff3cd; padding: 10px; border-radius: 6px; margin-bottom: 10px; color: #856404; font-size: 0.9rem; text-align: center; display: none; }
    .message.show { display: block; }
    .message.error { background: #f8d7da; color: #721c24; }
    .message.success { background: #d4edda; color: #155724; }
    .controls { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
    .btn.send { background: #5a9; }
    .btn.send:hover { background: #4a8; }
    .overlay { background: rgba(255,255,255,0.95); }
    .overlay h2 { animation: pop 0.5s ease; }
    @keyframes pop { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }
    .stats { color: #6b5b7a; margin-bottom: 15px; font-size: 0.95rem; }
  </style>
</head>
<body>
  <h1>ポケモンしりとり</h1>
  <div class="game-container">
    <div class="score-area">
      <div class="score-box">
        <div class="label">つづいた数</div>
        <div class="value" id="chainCount">0</div>
      </div>
      <div class="score-box">
        <div class="label">ベスト</div>
        <div class="value" id="bestCount">0</div>
      </div>
    </div>
    <div class="chain-display">
      <div class="current-char" id="currentChar">好きなポケモンから始めよう！</div>
      <div class="hint" id="hint"></div>
    </div>
    <div class="history" id="history"></div>
    <div class="message" id="message"></div>
    <div class="input-area">
      <input type="text" id="input" placeholder="ポケモンの名前を入力" autocomplete="off">
      <button class="btn send" id="sendBtn">送信</button>
    </div>
    <div class="controls">
      <button class="btn small" id="hintBtn">ヒント</button>
      <button class="btn small" id="giveupBtn">ギブアップ</button>
      <button class="btn small" id="restartBtn">リスタート</button>
    </div>
  </div>
  <details class="how-to-play" style="margin-top: 15px;">
    <summary>あそびかた</summary>
    <div class="content">
      <ul>
        <li>ポケモンの名前でしりとりをしよう！</li>
        <li>前のポケモンの<strong>最後の文字</strong>から始まる名前を答えてね</li>
        <li>「<strong>ン</strong>」で終わるポケモンを言ったら負け！</li>
        <li>同じポケモンは使えないよ</li>
        <li>わからなかったら「ヒント」ボタンを押してね</li>
      </ul>
    </div>
  </details>
  <div class="overlay" id="overlay">
    <h2 id="resultTitle">ゲームオーバー</h2>
    <p class="stats" id="resultStats"></p>
    <button class="btn" id="retryBtn">もう一度</button>
  </div>

  <script>
    // ポケモンリスト（JSONファイルから読み込み）
    // データソース: PokeAPI (https://github.com/PokeAPI/api-data)
    let POKEMON = [];  // [{id, name}, ...]
    let SPRITE_URL = '';  // スプライト画像のURLテンプレート

    // ひらがな変換用
    const KATAKANA_TO_HIRAGANA = str => str.replace(/[\u30A1-\u30F6]/g, c => String.fromCharCode(c.charCodeAt(0) - 0x60));
    const HIRAGANA_TO_KATAKANA = str => str.replace(/[\u3041-\u3096]/g, c => String.fromCharCode(c.charCodeAt(0) + 0x60));
    const normalize = str => HIRAGANA_TO_KATAKANA(str.trim().toUpperCase());

    // 小文字を大文字に変換（ァ→ア、ッ→ツなど）
    const toBigChar = c => {
      const small = 'ァィゥェォャュョッ';
      const big = 'アイウエオヤユヨツ';
      const idx = small.indexOf(c);
      return idx >= 0 ? big[idx] : c;
    };

    // 最後の文字を取得（ー は無視）
    const getLastChar = name => {
      let last = name[name.length - 1];
      if (last === 'ー' && name.length > 1) {
        last = name[name.length - 2];
      }
      return toBigChar(last);
    };

    let usedPokemon = new Set();
    let currentChar = '';
    let chainCount = 0;
    let bestCount = parseInt(localStorage.getItem('pokemonShiritoriBest') || '0');
    let gameOver = false;
    let isFirstTurn = true;

    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const historyEl = document.getElementById('history');
    const currentCharEl = document.getElementById('currentChar');
    const hintEl = document.getElementById('hint');
    const messageEl = document.getElementById('message');
    const chainCountEl = document.getElementById('chainCount');
    const bestCountEl = document.getElementById('bestCount');
    const overlay = document.getElementById('overlay');
    const resultTitleEl = document.getElementById('resultTitle');
    const resultStatsEl = document.getElementById('resultStats');

    bestCountEl.textContent = bestCount;

    function showMessage(text, type = '') {
      messageEl.textContent = text;
      messageEl.className = 'message show ' + type;
      setTimeout(() => messageEl.classList.remove('show'), 3000);
    }

    function addHistory(pokemon, isPlayer) {
      const div = document.createElement('div');
      div.className = 'history-item ' + (isPlayer ? 'player' : 'cpu');
      const lastChar = getLastChar(pokemon.name);
      const spriteUrl = SPRITE_URL.replace('{id}', pokemon.id);
      div.innerHTML = `
        <img class="sprite" src="${spriteUrl}" alt="${pokemon.name}" onerror="this.style.display='none'">
        <div class="info">
          <span class="name">${isPlayer ? 'あなた' : 'CPU'}: ${pokemon.name}</span>
          <span class="char">→${lastChar}</span>
        </div>`;
      historyEl.appendChild(div);
      historyEl.scrollTop = historyEl.scrollHeight;
    }

    function updateDisplay() {
      chainCountEl.textContent = chainCount;
      if (currentChar) {
        currentCharEl.textContent = `「${currentChar}」から始まるポケモン！`;
        // ヒントを表示
        const available = getAvailablePokemon(currentChar);
        hintEl.textContent = `残り ${available.length} 匹`;
      }
    }

    function getAvailablePokemon(startChar) {
      return POKEMON.filter(p => p.name[0] === startChar && !usedPokemon.has(p.name));
    }

    function findPokemon(name) {
      const normalized = normalize(name);
      return POKEMON.find(p => p.name === normalized);
    }

    function cpuTurn() {
      const available = getAvailablePokemon(currentChar);
      if (available.length === 0) {
        // CPUが答えられない
        endGame(true, 'CPUが答えられなかった！');
        return;
      }

      // ンで終わらないポケモンを優先
      const safe = available.filter(p => !p.name.endsWith('ン'));
      const choice = safe.length > 0 ? safe[Math.floor(Math.random() * safe.length)] : available[Math.floor(Math.random() * available.length)];

      setTimeout(() => {
        usedPokemon.add(choice.name);
        addHistory(choice, false);
        chainCount++;

        if (choice.name.endsWith('ン')) {
          endGame(true, 'CPUが「ン」で終わるポケモンを言った！');
          return;
        }

        currentChar = getLastChar(choice.name);
        updateDisplay();
        inputEl.disabled = false;
        inputEl.focus();
      }, 800);
    }

    function playerTurn(name) {
      const pokemon = findPokemon(name);

      if (!pokemon) {
        showMessage('そのポケモンは見つからないよ', 'error');
        return false;
      }

      if (usedPokemon.has(pokemon.name)) {
        showMessage('そのポケモンはもう使ったよ', 'error');
        return false;
      }

      if (!isFirstTurn && pokemon.name[0] !== currentChar) {
        showMessage(`「${currentChar}」から始まるポケモンを言ってね`, 'error');
        return false;
      }

      usedPokemon.add(pokemon.name);
      addHistory(pokemon, true);
      chainCount++;
      isFirstTurn = false;

      if (pokemon.name.endsWith('ン')) {
        endGame(false, '「ン」で終わっちゃった...');
        return true;
      }

      currentChar = getLastChar(pokemon.name);
      updateDisplay();
      inputEl.value = '';
      inputEl.disabled = true;

      // CPUのターン
      cpuTurn();
      return true;
    }

    function endGame(playerWin, reason) {
      gameOver = true;
      inputEl.disabled = true;

      if (chainCount > bestCount) {
        bestCount = chainCount;
        localStorage.setItem('pokemonShiritoriBest', bestCount);
        bestCountEl.textContent = bestCount;
      }

      resultTitleEl.textContent = playerWin ? 'やったね！' : 'ざんねん...';
      resultStatsEl.textContent = `${reason}\nつづいた数: ${chainCount}`;
      overlay.classList.add('show');
    }

    function showHint() {
      if (gameOver || isFirstTurn) {
        showMessage('好きなポケモンから始めてね！', 'success');
        return;
      }

      const available = getAvailablePokemon(currentChar);
      if (available.length > 0) {
        const hint = available[Math.floor(Math.random() * available.length)];
        showMessage(`ヒント: ${hint.name.substring(0, 2)}...`, 'success');
      } else {
        showMessage('答えられるポケモンがいない！ギブアップしよう', 'error');
      }
    }

    function restart() {
      usedPokemon.clear();
      currentChar = '';
      chainCount = 0;
      gameOver = false;
      isFirstTurn = true;
      historyEl.innerHTML = '';
      inputEl.value = '';
      inputEl.disabled = false;
      currentCharEl.textContent = '好きなポケモンから始めよう！';
      hintEl.textContent = '';
      overlay.classList.remove('show');
      updateDisplay();
      inputEl.focus();
    }

    // イベント
    sendBtn.addEventListener('click', () => {
      if (!gameOver && inputEl.value.trim()) {
        playerTurn(inputEl.value);
      }
    });

    inputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !gameOver && inputEl.value.trim()) {
        playerTurn(inputEl.value);
      }
    });

    document.getElementById('hintBtn').addEventListener('click', showHint);
    document.getElementById('giveupBtn').addEventListener('click', () => {
      if (!gameOver) {
        endGame(false, 'ギブアップ');
      }
    });
    document.getElementById('restartBtn').addEventListener('click', restart);
    document.getElementById('retryBtn').addEventListener('click', restart);

    // ポケモンデータを読み込んでゲームを開始
    async function initGame() {
      try {
        currentCharEl.textContent = '読み込み中...';
        inputEl.disabled = true;

        const response = await fetch('pokemon-data.json');
        const data = await response.json();
        POKEMON = data.pokemon;
        SPRITE_URL = data.spriteUrl;

        currentCharEl.textContent = '好きなポケモンから始めよう！';
        hintEl.textContent = `全${POKEMON.length}匹のポケモンが登録されています`;
        inputEl.disabled = false;
        inputEl.focus();
      } catch (error) {
        currentCharEl.textContent = 'データの読み込みに失敗しました';
        console.error('ポケモンデータの読み込みエラー:', error);
      }
    }

    // 初期化
    initGame();
  </script>
</body>
</html>
